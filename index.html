<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Salesforce Knowledge Import Tool - Import with Images & Data Categories</title>
    <meta name="description" content="Free online tool to prepare exported Salesforce Knowledge articles for import. Full support for images and data categories. Extract rich text, download images, map lookups, transform data categories, and generate ZIP files ready for import. No installation required.">
    <meta name="keywords" content="Salesforce, Knowledge, Import, Images, Data Categories, CSV, Converter, Tool, Article Import, Salesforce Knowledge Base, Free Tool, Salesforce Admin, Knowledge Article, Bulk Import, Salesforce Migration, Rich Text, Image Import">
    <meta name="author" content="Salesforce Knowledge Tool">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://abhiram96.github.io/salesforce-knowledge-import-tool/">
    
    <!-- Open Graph for Social Sharing -->
    <meta property="og:title" content="Salesforce Knowledge Import Tool - Images & Data Categories Support">
    <meta property="og:description" content="Prepare exported Knowledge articles for import with full support for images and data categories. Extract rich text, download images, map lookups, and transform data categories. 100% free and client-side processing.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://abhiram96.github.io/salesforce-knowledge-import-tool/">
    <meta property="og:site_name" content="Salesforce Knowledge Import Tool">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Salesforce Knowledge Import Tool">
    <meta name="twitter:description" content="Free tool to prepare Knowledge articles for import with images and data categories support. Rich text extraction, image download, lookup mapping, and more.">
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sf-blue': {
                            50: '#E8F3FB',
                            100: '#D1E8F7',
                            200: '#A3D0EF',
                            300: '#75B9E7',
                            400: '#47A1DF',
                            500: '#0176D3',
                            600: '#0B5CAB',
                            700: '#054487',
                            800: '#032D60',
                            900: '#001639',
                        },
                        'sf-success': '#04844B',
                        'sf-warning': '#FFB75D',
                        'sf-error': '#EA001E',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Salesforce Sans', Arial, sans-serif;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Lucide icons as inline SVG components
        const Upload = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        );
        
        const FileText = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        );
        
        const Settings = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
          </svg>
        );
        
        const Download = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        );
        
        const ChevronRight = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        );
        
        const ChevronLeft = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        );
        
        const Check = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        );
        
        const AlertCircle = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        );
        
        const Plus = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        );
        
        const X = ({size = 24, ...props}) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        );

        const SalesforceKnowledgeImportTool = () => {
          const [step, setStep] = React.useState(0);
          const [csvData, setCsvData] = React.useState(null);
          const [csvHeaders, setCsvHeaders] = React.useState([]);
          const [richTextColumns, setRichTextColumns] = React.useState([]);
          const [toast, setToast] = React.useState({ show: false, message: '', type: 'success' });
          const [copiedButton, setCopiedButton] = React.useState(null);
          const [lookupFields, setLookupFields] = React.useState([]);
          const [recordTypeData, setRecordTypeData] = React.useState({ 
            enabled: false, 
            columnName: '', 
            pastedData: '', 
            parsedData: null 
          });
          const [dataCategoryGroups, setDataCategoryGroups] = React.useState([]);
          const [dataCategoryConfig, setDataCategoryConfig] = React.useState({ 
            format: '', // 'json' or 'columns'
            selectionColumn: '', // For JSON format
            columnMappings: [] // For column format: [{groupNameCol: '', categoryNameCol: ''}]
          });
          const [channelsConfig, setChannelsConfig] = React.useState({
            mode: 'manual', // 'manual' or 'columns'
            // Manual mode (checkboxes)
            application: true,  // Default
            sites: false,
            csp: false,
            prm: false,
            // Columns mode (from CSV)
            columnMappings: {
              application: '', // Maps to IsVisibleInApp
              csp: '',         // Maps to IsVisibleInCsp
              sites: '',       // Maps to IsVisibleInPkb
              prm: ''          // Maps to IsVisibleInPrm
            }
          });
          const [translationConfig, setTranslationConfig] = React.useState({
            hasTranslations: false,
            languageColumn: '',
            isMasterLanguageColumn: '',
            articleNumberColumn: '',
            detectedLanguages: []
          });
          const [imageReferences, setImageReferences] = React.useState([]);
          const [uploadedImages, setUploadedImages] = React.useState({});
          const [orgAlias, setOrgAlias] = React.useState('');
          const [exportConfig, setExportConfig] = React.useState({
            sourceOrgAlias: '',
            soqlQuery: `SELECT Title, RecordType.Name, 
  (SELECT DataCategoryGroupName, 
          DataCategoryName 
   FROM DataCategorySelections) 
FROM Knowledge__kav 
WHERE PublishStatus = 'Online' 
  AND IsLatestVersion = true`
          });
          const [outputSettings, setOutputSettings] = React.useState({
            csvEncoding: 'UTF-8',
            csvSeparator: ',',
            htmlEncoding: 'UTF-8',
            dateFormat: 'yyyy-MM-dd',
            dateTimeFormat: 'yyyy-MM-dd HH:mm:ss',
            outputFilename: 'PreppedData.csv'
          });
          const [validationErrors, setValidationErrors] = React.useState({});
          const [warningAcknowledged, setWarningAcknowledged] = React.useState({});
          const [removedLookupFields, setRemovedLookupFields] = React.useState([]);
          const fileInputRef = React.useRef(null);
          const imagesInputRef = React.useRef(null);
          const validationErrorRef = React.useRef(null);

          // Auto-scan for images when step 4 is reached
          React.useEffect(() => {
            if (step === 4 && richTextColumns.length > 0 && imageReferences.length === 0 && !imagesScanned) {
              scanAllImagesInCSV();
            }
            // Reset scanned state when leaving step 4
            if (step !== 4) {
              setImagesScanned(false);
            }
            
            // Clear warning acknowledgments when navigating to a new step
            setWarningAcknowledged({});
          }, [step]);

          // Scroll to validation error/warning when it appears
          React.useEffect(() => {
            if (Object.keys(validationErrors).length > 0 && validationErrorRef.current) {
              validationErrorRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, [validationErrors]);

          // Clear removed lookup fields warning when leaving step 5
          React.useEffect(() => {
            if (step !== 5) {
              setRemovedLookupFields([]);
            }
          }, [step]);

          // Remove fields from removedLookupFields if they are re-added to lookupFields
          React.useEffect(() => {
            if (removedLookupFields.length > 0) {
              const currentFieldNames = lookupFields.map(l => l.fieldName);
              setRemovedLookupFields(prev => 
                prev.filter(fieldName => !currentFieldNames.includes(fieldName))
              );
            }
          }, [lookupFields]);

          const showToast = (message, type = 'success') => {
            setToast({ show: true, message, type });
            // Longer timeout for errors and warnings so users can read them
            const timeout = (type === 'error' || type === 'warning') ? 5000 : 3000;
            setTimeout(() => {
              setToast({ show: false, message: '', type: 'success' });
            }, timeout);
          };

          const handleCopyClick = (buttonId, textToCopy) => {
            navigator.clipboard.writeText(textToCopy);
            setCopiedButton(buttonId);
            setTimeout(() => {
              setCopiedButton(null);
            }, 2000);
          };

          const validateAndGetGroupName = (columnName, setError = false) => {
            if (!columnName || !csvData) return null;
            
            const values = new Set();
            let firstNonEmptyValue = null;
            
            csvData.forEach(row => {
              const value = row[columnName];
              if (value && value.trim() !== '') {
                const trimmedValue = value.trim();
                values.add(trimmedValue);
                if (!firstNonEmptyValue) {
                  firstNonEmptyValue = trimmedValue;
                }
              }
            });
            
            // Check if all non-empty values are the same
            if (values.size > 1) {
              const differentValues = Array.from(values).slice(0, 3).join(', ');
              if (setError) {
                setValidationErrors(prev => ({
                  ...prev,
                  [`dataCategory_${columnName}`]: `DataCategoryGroupName column "${columnName}" has different values: ${differentValues}. All values in this column must be the same. Each DataCategoryGroupName should be its own separate column.`
                }));
              }
              return null;
            } else if (setError) {
              // Clear error for this column if validation passes
              setValidationErrors(prev => {
                const newErrors = { ...prev };
                delete newErrors[`dataCategory_${columnName}`];
                return newErrors;
              });
            }
            
            return firstNonEmptyValue;
          };

          const steps = [
            { number: 0, title: 'Welcome', icon: FileText },
            { number: 1, title: 'Upload CSV', icon: Upload },
            { number: 2, title: 'Map Columns', icon: Settings },
            { number: 3, title: 'Rich Text', icon: FileText },
            { number: 4, title: 'Images', icon: Download },
            { number: 5, title: 'Lookups', icon: Settings },
            { number: 6, title: 'Categories', icon: Settings },
            { number: 7, title: 'Channels', icon: Settings },
            { number: 8, title: 'Generate', icon: Download }
          ].filter(s => {
            // Hide Images step if no rich text columns
            if (s.number === 4 && richTextColumns.length === 0) return false;
            return true;
          });
          
          const handleStepClick = (targetStep) => {
            // Can always go back without validation
            if (targetStep < step) {
              // But handle skipped steps when going back
              // If target is step 4 and no rich text columns, user can't go there
              if (targetStep === 4 && richTextColumns.length === 0) {
                showToast('Images step is not available (no rich text fields detected)', 'info');
                return;
              }
              setStep(targetStep);
              return;
            }
            
            // Can't skip steps forward - only allow next step
            if (targetStep > step + 1) {
              showToast('Please complete the current step first. You cannot skip steps.', 'warning');
              return;
            }
            
            // Going to next step (targetStep === step + 1) - apply validation
            if (targetStep === step + 1) {
              // Check if CSV is uploaded (except for step 0)
              if (step > 0 && !csvData) {
                showToast('Please upload a CSV file first', 'warning');
                return;
              }
              
              // Apply step transition validation
              const validationResult = validateStepTransition(step);
              if (!validationResult.canProceed) {
                // Set warning acknowledged for next click if it's a warning
                if (validationResult.hasWarning) {
                  // For step 4 images, need to check which warning type
                  if (step === 4 && imageReferences.length > 0) {
                    const uploadedCount = Object.keys(uploadedImages).length;
                    if (uploadedCount === 0) {
                      setWarningAcknowledged(prev => ({ ...prev, [`step${step}_none`]: true }));
                    } else if (uploadedCount < imageReferences.length) {
                      setWarningAcknowledged(prev => ({ ...prev, [`step${step}_partial`]: true }));
                    }
                  } else {
                    setWarningAcknowledged(prev => ({ ...prev, [`step${step}`]: true }));
                  }
                }
                return; // Validation failed or warning not acknowledged yet
              }
              
              // Clear warning acknowledgment after proceeding
              setWarningAcknowledged(prev => {
                const newState = { ...prev };
                delete newState[`step${step}`];
                delete newState[`step${step}_none`];
                delete newState[`step${step}_partial`];
                return newState;
              });
              
              // Handle step 4 skip if no rich text columns
              let nextStep = targetStep;
              if (step === 3 && richTextColumns.length === 0) {
                nextStep = 5; // Skip step 4 (Images)
              }
              
              setStep(Math.min(8, nextStep));
            }
          };

          const extractImageReferences = (htmlContent) => {
            const images = [];
            if (!htmlContent) return images;
            
            // Match img tags with Salesforce rtaImage URLs
            const imgRegex = /<img[^>]+src=["']([^"']*rtaImage[^"']*)["'][^>]*>/gi;
            let match;
            
            while ((match = imgRegex.exec(htmlContent)) !== null) {
              const url = match[1].replace(/&amp;/g, '&');
              
              // Extract parameters from URL
              const eidMatch = url.match(/[?&]eid=([^&]+)/);
              const refidMatch = url.match(/[?&]refid=([^&]+)/);
              const feoidMatch = url.match(/[?&]feoid=([^&]+)/);
              
              if (refidMatch) {
                const baseUrl = url.split('/servlet/')[0];
                images.push({
                  url: url,
                  baseUrl: baseUrl,
                  eid: eidMatch ? eidMatch[1] : null,
                  refid: refidMatch[1],
                  feoid: feoidMatch ? feoidMatch[1] : null
                });
              }
            }
            
            return images;
          };

          const [imagesScanned, setImagesScanned] = React.useState(false);

          const scanAllImagesInCSV = () => {
            if (!csvData || richTextColumns.length === 0) return;
            
            const allImages = [];
            const imagesByColumn = {}; // Track which columns use which images
            
            csvData.forEach((row, index) => {
              richTextColumns.forEach(column => {
                const htmlContent = row[column];
                if (htmlContent) {
                  const images = extractImageReferences(htmlContent);
                  images.forEach(img => {
                    const key = `${img.refid}-${column}`;
                    if (!imagesByColumn[key]) {
                      imagesByColumn[key] = true;
                      allImages.push({ ...img, row: index + 2, column });
                    }
                  });
                }
              });
            });
            
            setImageReferences(allImages);
            setImagesScanned(true);
          };

          const generateBashScript = () => {
            if (imageReferences.length === 0) return '';
            
            const configuredAlias = orgAlias || 'YOUR_ORG_ALIAS';
            
            let script = `#!/bin/bash
# Salesforce Knowledge Image Downloader
# Generated by Salesforce Knowledge Import Tool
#
# This script uses Salesforce CLI to authenticate and download images
#
# Prerequisites:
#   - Salesforce CLI must be installed (https://developer.salesforce.com/tools/salesforcecli)
#   - You must be authenticated to your org
#
# How to authenticate (if not already done):
#   sf org login web --alias ${configuredAlias} --instance-url https://test.salesforce.com
#
# Then run this script:
#   chmod +x download-images-*.sh && ./download-images-*.sh

set -e  # Exit on error

ORG_ALIAS="${configuredAlias}"
TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
OUTPUT_DIR="Images-$TIMESTAMP"

echo "=========================================="
echo "Salesforce Knowledge Image Downloader"
echo "=========================================="
echo ""

# Check if Salesforce CLI is installed
if ! command -v sf &> /dev/null; then
    echo "‚ùå ERROR: Salesforce CLI is not installed!"
    echo ""
    echo "Please install Salesforce CLI:"
    echo "  https://developer.salesforce.com/tools/salesforcecli"
    echo ""
    exit 1
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "‚ùå ERROR: jq is not installed!"
    echo ""
    echo "Please install jq:"
    echo "  Mac: brew install jq"
    echo "  Linux: sudo apt-get install jq"
    echo ""
    exit 1
fi

# Get access token and instance URL from Salesforce CLI
echo "Getting authentication from Salesforce CLI..."
echo "Using org alias: $ORG_ALIAS"
echo ""

# Try to get org info, redirect stderr separately
ORG_INFO=$(sf org display --target-org "$ORG_ALIAS" --json 2>/dev/null)

# Check if the command succeeded and returned valid JSON
if [ $? -ne 0 ] || [ -z "$ORG_INFO" ]; then
    echo "‚ùå ERROR: Failed to get org information!"
    echo ""
    echo "This usually means:"
    echo "  1. The org alias '$ORG_ALIAS' doesn't exist"
    echo "  2. You're not authenticated to this org"
    echo ""
    echo "To authenticate:"
    echo "  sf org login web --alias $ORG_ALIAS --instance-url https://test.salesforce.com"
    echo ""
    echo "To see your authenticated orgs:"
    echo "  sf org list"
    echo ""
    exit 1
fi

# Parse JSON to get access token and instance URL
ACCESS_TOKEN=$(echo "$ORG_INFO" | jq -r '.result.accessToken' 2>/dev/null)
INSTANCE_URL=$(echo "$ORG_INFO" | jq -r '.result.instanceUrl' 2>/dev/null)

if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
    echo "‚ùå ERROR: Failed to get access token!"
    echo ""
    echo "The org might not be authenticated properly."
    echo "Please re-authenticate:"
    echo "  sf org login web --alias $ORG_ALIAS --instance-url https://test.salesforce.com"
    echo ""
    exit 1
fi

echo "‚úì Authentication successful!"
echo "‚úì Instance: $INSTANCE_URL"
echo ""

# Create output directory
echo "Creating output directory: $OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"
echo ""

# Image data: eid|column|refid (pipe-separated for easy parsing)
# This compact format keeps the script size small regardless of image count
IMAGES=(
`;

            // Create compact data array
            imageReferences.forEach((img) => {
              script += `  "${img.eid}|${img.column}|${img.refid}"\n`;
            });

            script += `)

TOTAL_IMAGES=\${#IMAGES[@]}
echo "Downloading $TOTAL_IMAGES images..."
echo ""
echo "‚ÑπÔ∏è  Note: Salesforce API limits concurrent requests. This script processes images sequentially."
echo "   For large batches (500+ images), consider running during off-peak hours."
echo ""

# Download images by iterating through the array
COUNTER=0
for IMAGE_DATA in "\${IMAGES[@]}"; do
  COUNTER=$((COUNTER + 1))
  
  # Parse pipe-separated data
  IFS='|' read -r EID COLUMN REFID <<< "$IMAGE_DATA"
  
  echo "[$COUNTER/$TOTAL_IMAGES] Downloading $REFID (from $COLUMN)..."
  
  # Get image and detect format from Content-Type
  TEMP_FILE="$OUTPUT_DIR/$REFID.tmp"
  curl -s -o "$TEMP_FILE" \\
    --dump-header "$OUTPUT_DIR/headers-$REFID.tmp" \\
    --location \\
    --header "Authorization: Bearer $ACCESS_TOKEN" \\
    --header "Content-Type: application/json" \\
    "$INSTANCE_URL/services/data/v60.0/sobjects/Knowledge__kav/$EID/richTextImageFields/$COLUMN/$REFID"
  
  # Detect file extension from Content-Type header
  CONTENT_TYPE=$(grep -i "content-type:" "$OUTPUT_DIR/headers-$REFID.tmp" | sed 's/.*: *//; s/\\r//' | tr -d '\\n' | tr -d '\\r')
  EXT="png"  # Default to png
  case "$CONTENT_TYPE" in
    *image/jpeg*|*image/jpg*) EXT="jpg" ;;
    *image/png*) EXT="png" ;;
    *image/gif*) EXT="gif" ;;
  esac
  
  # Rename to correct extension
  mv "$TEMP_FILE" "$OUTPUT_DIR/$REFID.$EXT"
  rm -f "$OUTPUT_DIR/headers-$REFID.tmp"
  echo "  ‚úì Saved as $REFID.$EXT"
  echo ""
done

echo ""
echo "=========================================="
echo "Download Summary"
echo "=========================================="

TOTAL_FILES=$(ls -1 "$OUTPUT_DIR" 2>/dev/null | wc -l | tr -d ' ')
echo "Total files created: $TOTAL_FILES"

# Check for empty files
EMPTY_FILES=$(find "$OUTPUT_DIR" -type f -empty 2>/dev/null)
if [ -n "$EMPTY_FILES" ]; then
    EMPTY_COUNT=$(echo "$EMPTY_FILES" | wc -l | tr -d ' ')
    echo "‚ö†Ô∏è  Warning: $EMPTY_COUNT file(s) are empty:"
    echo "$EMPTY_FILES" | sed 's/^/  - /'
    echo ""
    echo "Empty files may indicate:"
    echo "  - Images don't exist in Salesforce"
    echo "  - Field name is incorrect"
    echo "  - Permission issues"
else
    echo "‚úì All files downloaded successfully!"
fi

echo ""
echo "=========================================="
echo "Next Steps"
echo "=========================================="
echo "1. Go back to the Salesforce Knowledge Import Tool"
echo "2. Click 'Select Image Files' in Step 4"
echo "3. Select all files from the '$OUTPUT_DIR' folder"
echo "4. Continue to generate your import package"
echo ""
`;

            return script;
          };

          const generatePythonScript = () => {
            if (imageReferences.length === 0) return '';
            
            const configuredAlias = orgAlias || 'YOUR_ORG_ALIAS';
            
            let script = `#!/usr/bin/env python3
"""
Salesforce Knowledge Image Downloader
Generated by Salesforce Knowledge Import Tool

This script uses Salesforce CLI to authenticate and download images

Prerequisites:
  - Salesforce CLI must be installed (https://developer.salesforce.com/tools/salesforcecli)
  - Python 3.6+ with requests library: pip install requests
  - You must be authenticated to your org

How to authenticate (if not already done):
  sf org login web --alias ${configuredAlias} --instance-url https://test.salesforce.com

Then run this script:
  python3 download-images-*.py
"""

import os
import sys
import json
import subprocess
import requests
from datetime import datetime

# Configuration
ORG_ALIAS = "${configuredAlias}"
TIMESTAMP = datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
OUTPUT_DIR = f"Images-{TIMESTAMP}"

def print_header():
    print("=" * 50)
    print("Salesforce Knowledge Image Downloader")
    print("=" * 50)
    print()

def check_prerequisites():
    """Check if required tools are installed"""
    errors = []
    
    # Check Salesforce CLI
    try:
        subprocess.run(['sf', '--version'], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        errors.append("Salesforce CLI is not installed")
        errors.append("Install from: https://developer.salesforce.com/tools/salesforcecli")
    
    # Check requests library
    try:
        import requests
    except ImportError:
        errors.append("Python 'requests' library is not installed")
        errors.append("Install with: pip install requests")
    
    if errors:
        print("‚ùå ERROR: Missing prerequisites:\\n")
        for error in errors:
            print(f"  - {error}")
        print()
        sys.exit(1)

def get_access_token(org_alias):
    """Get access token using Salesforce CLI"""
    print(f"Getting authentication from Salesforce CLI...")
    print(f"Using org alias: {org_alias}")
    print()
    
    try:
        result = subprocess.run(
            ['sf', 'org', 'display', '--target-org', org_alias, '--json'],
            capture_output=True,
            text=True
        )
        
        # Check if command failed
        if result.returncode != 0:
            print("‚ùå ERROR: Failed to get org information!\\n")
            print("This usually means:")
            print(f"  1. The org alias '{org_alias}' doesn't exist")
            print(f"  2. You're not authenticated to this org\\n")
            print("To authenticate:")
            print(f"  sf org login web --alias {org_alias} --instance-url https://test.salesforce.com\\n")
            print("To see your authenticated orgs:")
            print("  sf org list\\n")
            if result.stderr:
                print(f"Error details: {result.stderr}")
            sys.exit(1)
        
        # Try to parse JSON
        try:
            org_info = json.loads(result.stdout)
        except json.JSONDecodeError as e:
            print(f"‚ùå ERROR: Failed to parse Salesforce CLI output!\\n")
            print(f"JSON Error: {e}\\n")
            print("This might be a Salesforce CLI issue. Try running:")
            print(f"  sf org display --target-org {org_alias}\\n")
            sys.exit(1)
        
        # Extract tokens
        access_token = org_info.get('result', {}).get('accessToken')
        instance_url = org_info.get('result', {}).get('instanceUrl')
        
        if not access_token or access_token == 'null':
            print("‚ùå ERROR: Failed to get access token!\\n")
            print("The org might not be authenticated properly.")
            print("Please re-authenticate:")
            print(f"  sf org login web --alias {org_alias} --instance-url https://test.salesforce.com\\n")
            sys.exit(1)
        
        print(f"‚úì Authentication successful!")
        print(f"‚úì Instance: {instance_url}")
        print()
        
        return access_token, instance_url
        
    except FileNotFoundError:
        print("‚ùå ERROR: Salesforce CLI 'sf' command not found!\\n")
        print("Please install Salesforce CLI:")
        print("  https://developer.salesforce.com/tools/salesforcecli\\n")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå ERROR: Unexpected error: {e}\\n")
        sys.exit(1)

def download_images(access_token, instance_url):
    """Download all images"""
    images = [
`;

            imageReferences.forEach((img) => {
              script += `        {"eid": "${img.eid}", "refid": "${img.refid}", "column": "${img.column}"},
`;
            });

            script += `    ]
    
    print(f"Creating output directory: {OUTPUT_DIR}")
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    print()
    
    print(f"Downloading {len(images)} images...")
    print()
    print("‚ÑπÔ∏è  Note: Salesforce API limits concurrent requests. This script processes images sequentially.")
    print("   For large batches (500+ images), consider running during off-peak hours.")
    print()
    
    headers = {
        'Authorization': f'Bearer {access_token}',
        'Content-Type': 'application/json'
    }
    
    empty_files = []
    success_count = 0
    
    for i, img in enumerate(images, 1):
        url = f"{instance_url}/services/data/v60.0/sobjects/Knowledge__kav/{img['eid']}/richTextImageFields/{img['column']}/{img['refid']}"
        
        print(f"[{i}/{len(images)}] Downloading {img['refid']} (from {img['column']})...")
        
        try:
            response = requests.get(url, headers=headers, timeout=30)
            response.raise_for_status()
            
            # Detect file extension from Content-Type header
            content_type = response.headers.get('Content-Type', '').lower()
            ext = 'png'  # Default to png
            if 'image/jpeg' in content_type or 'image/jpg' in content_type:
                ext = 'jpg'
            elif 'image/png' in content_type:
                ext = 'png'
            elif 'image/gif' in content_type:
                ext = 'gif'
            
            output_file = os.path.join(OUTPUT_DIR, f"{img['refid']}.{ext}")
            
            with open(output_file, 'wb') as f:
                f.write(response.content)
            
            # Check if file is empty
            if os.path.getsize(output_file) == 0:
                empty_files.append(img['refid'])
            else:
                success_count += 1
                print(f"  ‚úì Saved as {img['refid']}.{ext}")
                
        except Exception as e:
            print(f"  ‚úó Error: {e}")
            empty_files.append(img['refid'])
            continue
    
    return success_count, empty_files, len(images)

def print_summary(success_count, empty_files, total):
    """Print download summary"""
    print()
    print("=" * 50)
    print("Download Summary")
    print("=" * 50)
    print(f"Total files created: {success_count}")
    
    if empty_files:
        print(f"‚ö†Ô∏è  Warning: {len(empty_files)} file(s) are empty or failed:")
        for refid in empty_files[:5]:
            print(f"  - {refid}.png")
        if len(empty_files) > 5:
            print(f"  ... and {len(empty_files) - 5} more")
        print()
        print("Empty files may indicate:")
        print("  - Images don't exist in Salesforce")
        print("  - Field name is incorrect")
        print("  - Permission issues")
    else:
        print("‚úì All files downloaded successfully!")
    
    print()
    print("=" * 50)
    print("Next Steps")
    print("=" * 50)
    print("1. Go back to the Salesforce Knowledge Import Tool")
    print("2. Click 'Select Image Files' in Step 4")
    print(f"3. Select all files from the '{OUTPUT_DIR}' folder")
    print("4. Continue to generate your import package")
    print()

def main():
    print_header()
    check_prerequisites()
    access_token, instance_url = get_access_token(ORG_ALIAS)
    success_count, empty_files, total = download_images(access_token, instance_url)
    print_summary(success_count, empty_files, total)

if __name__ == "__main__":
    main()
`;

            return script;
          };

          const generateTimestamp = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}`;
          };

          const downloadScript = (content, baseFilename) => {
            // Extract extension and base name
            const parts = baseFilename.split('.');
            const extension = parts.pop();
            const name = parts.join('.');
            
            // Add timestamp to filename
            const timestamp = generateTimestamp();
            const filename = `${name}-${timestamp}.${extension}`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };

          const generateExportBashScript = () => {
            const sourceOrg = exportConfig.sourceOrgAlias || 'YOUR_SOURCE_ORG_ALIAS';
            const query = exportConfig.soqlQuery;
            
            const script = `#!/bin/bash
# Salesforce Knowledge Article CSV Export Script
# This script exports Knowledge articles from Salesforce using SF CLI
# Generated on ${new Date().toLocaleString()}

# Configuration
SOURCE_ORG="${sourceOrg}"
OUTPUT_FOLDER="KnowledgeExport-$(date +%Y-%m-%d-%H-%M-%S)"

echo "=================================================="
echo "  Salesforce Knowledge Article CSV Export"
echo "=================================================="
echo ""

# Check if SF CLI is installed
if ! command -v sf &> /dev/null; then
    echo "‚ùå Error: Salesforce CLI (sf) is not installed"
    echo "Please install it from: https://developer.salesforce.com/tools/sfdxcli"
    exit 1
fi

# Check if org alias is configured
echo "üîç Checking source org connection..."
if ! sf org display --target-org "\${SOURCE_ORG}" &> /dev/null; then
    echo "‚ùå Error: Cannot connect to org '\${SOURCE_ORG}'"
    echo "Please authenticate using: sf org login web --alias \${SOURCE_ORG}"
    exit 1
fi

echo "‚úì Successfully connected to org: \${SOURCE_ORG}"
echo ""

# Create output folder
mkdir -p "\${OUTPUT_FOLDER}"

# SOQL Query
read -r -d '' SOQL_QUERY << 'EOF'
${query}
EOF

echo "üìä Executing SOQL query..."
echo ""

# Execute query and save as CSV
sf data query \\
  --query "\${SOQL_QUERY}" \\
  --target-org "\${SOURCE_ORG}" \\
  --result-format csv \\
  > "\${OUTPUT_FOLDER}/KnowledgeArticles.csv"

if [ $? -eq 0 ]; then
    echo "‚úì Export completed successfully!"
    echo ""
    echo "=================================================="
    echo "  Next Steps"
    echo "=================================================="
    echo "1. Open the Salesforce Knowledge Import Tool"
    echo "2. Go to Step 1 (Upload CSV)"
    echo "3. Upload the file: \${OUTPUT_FOLDER}/KnowledgeArticles.csv"
    echo ""
else
    echo "‚ùå Error: Export failed"
    exit 1
fi
`;
            return script;
          };

          const generateExportPythonScript = () => {
            const sourceOrg = exportConfig.sourceOrgAlias || 'YOUR_SOURCE_ORG_ALIAS';
            const query = exportConfig.soqlQuery;
            
            const script = `#!/usr/bin/env python3
"""
Salesforce Knowledge Article CSV Export Script
This script exports Knowledge articles from Salesforce using SF CLI
Generated on ${new Date().toLocaleString()}
"""

import subprocess
import sys
import os
from datetime import datetime

# Configuration
SOURCE_ORG = "${sourceOrg}"
OUTPUT_FOLDER = f"KnowledgeExport-{datetime.now().strftime('%Y-%m-%d-%H-%M-%S')}"

def print_header():
    """Print header"""
    print("=" * 50)
    print("  Salesforce Knowledge Article CSV Export")
    print("=" * 50)
    print()

def check_sf_cli():
    """Check if Salesforce CLI is installed"""
    try:
        subprocess.run(['sf', '--version'], 
                      stdout=subprocess.PIPE, 
                      stderr=subprocess.PIPE,
                      check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("‚ùå Error: Salesforce CLI (sf) is not installed")
        print("Please install it from: https://developer.salesforce.com/tools/sfdxcli")
        return False

def check_org_connection():
    """Check if org is accessible"""
    print(f"üîç Checking source org connection...")
    try:
        subprocess.run(['sf', 'org', 'display', '--target-org', SOURCE_ORG],
                      stdout=subprocess.PIPE,
                      stderr=subprocess.PIPE,
                      check=True)
        print(f"‚úì Successfully connected to org: {SOURCE_ORG}")
        print()
        return True
    except subprocess.CalledProcessError:
        print(f"‚ùå Error: Cannot connect to org '{SOURCE_ORG}'")
        print(f"Please authenticate using: sf org login web --alias {SOURCE_ORG}")
        return False

def export_articles():
    """Export Knowledge articles to CSV"""
    # Create output folder
    os.makedirs(OUTPUT_FOLDER, exist_ok=True)
    
    # SOQL Query
    soql_query = """${query.replace(/"/g, '\\"')}"""
    
    print("üìä Executing SOQL query...")
    print()
    
    # Output file path
    output_file = os.path.join(OUTPUT_FOLDER, "KnowledgeArticles.csv")
    
    try:
        # Execute SF CLI command and capture output
        result = subprocess.run(
            ['sf', 'data', 'query',
             '--query', soql_query,
             '--target-org', SOURCE_ORG,
             '--result-format', 'csv'],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            check=True
        )
        
        # Write CSV output to file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(result.stdout)
        
        print("‚úì Export completed successfully!")
        print()
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Error: Export failed")
        print(f"Error message: {e.stderr}")
        return False

def print_next_steps():
    """Print next steps"""
    print("=" * 50)
    print("  Next Steps")
    print("=" * 50)
    print("1. Open the Salesforce Knowledge Import Tool")
    print("2. Go to Step 1 (Upload CSV)")
    print(f"3. Upload the file: {OUTPUT_FOLDER}/KnowledgeArticles.csv")
    print()

def main():
    print_header()
    
    if not check_sf_cli():
        sys.exit(1)
    
    if not check_org_connection():
        sys.exit(1)
    
    if not export_articles():
        sys.exit(1)
    
    print_next_steps()

if __name__ == "__main__":
    main()
`;
            return script;
          };

          const validateStepTransition = (currentStep) => {
            // Clear previous validation errors for this step
            setValidationErrors(prev => {
              const newErrors = { ...prev };
              // Clear errors for the current step
              Object.keys(newErrors).forEach(key => {
                if (key.startsWith(`step${currentStep}_`)) {
                  delete newErrors[key];
                }
              });
              return newErrors;
            });
            
            // Step 2: Map Columns - validate translation requirements
            if (currentStep === 2 && translationConfig.hasTranslations) {
              const missingColumns = [];
              
              if (!translationConfig.isMasterLanguageColumn) {
                missingColumns.push('isMasterLanguage');
              }
              if (!translationConfig.articleNumberColumn) {
                missingColumns.push('ArticleNumber');
              }
              
              if (missingColumns.length > 0) {
                setValidationErrors(prev => ({
                  ...prev,
                  step2_translationColumns: {
                    type: 'error',
                    message: `Translations detected (${translationConfig.detectedLanguages.length} languages: ${translationConfig.detectedLanguages.join(', ')}), but required column(s) missing: ${missingColumns.join(', ')}. These columns are mandatory to import articles with translations. The ArticleNumber column is used to group the same article in different languages (e.g., Article 1 in English and Article 1 in French should both have ArticleNumber = 1). Please add these columns to your CSV and upload again.`
                  }
                }));
                setTimeout(() => {
                  validationErrorRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                return { hasWarning: false, canProceed: false };
              }
            }
            
            // Step 4: Images - warn if images detected but not uploaded or partially uploaded
            if (currentStep === 4 && imageReferences.length > 0) {
              const uploadedCount = Object.keys(uploadedImages).length;
              
              if (uploadedCount === 0) {
                // No images uploaded at all
                if (!warningAcknowledged[`step${currentStep}_none`]) {
                  setValidationErrors(prev => ({
                    ...prev,
                    step4_images: {
                      type: 'warning',
                      message: `${imageReferences.length} image(s) detected but not uploaded. Images will NOT be included in the import and references will be broken. Click "Next" again to proceed anyway.`
                    }
                  }));
                  return { hasWarning: true, canProceed: false };
                }
              } else if (uploadedCount < imageReferences.length) {
                // Some images uploaded but not all
                if (!warningAcknowledged[`step${currentStep}_partial`]) {
                  setValidationErrors(prev => ({
                    ...prev,
                    step4_images: {
                      type: 'warning',
                      message: `Only ${uploadedCount} of ${imageReferences.length} image(s) uploaded. ${imageReferences.length - uploadedCount} image(s) are missing and will NOT be included in the import. Click "Next" again to proceed anyway.`
                    }
                  }));
                  return { hasWarning: true, canProceed: false };
                }
              }
            }
            
            // Step 5: Lookups - validate RecordType and other lookups
            if (currentStep === 5) {
              // Check RecordType (mandatory)
              if (recordTypeData.enabled && !recordTypeData.parsedData) {
                setValidationErrors(prev => ({
                  ...prev,
                  step5_recordType: {
                    type: 'error',
                    message: 'RecordType lookup is mandatory. Please paste the SOQL query results for RecordType.'
                  }
                }));
                return { hasWarning: false, canProceed: false };
              }
              
              // Check for NOT FOUND values in RecordType
              if (recordTypeData.enabled && recordTypeData.parsedData && recordTypeData.columnName) {
                const notFoundRecords = csvData.filter(row => {
                  const recordTypeValue = row[recordTypeData.columnName];
                  if (!recordTypeValue || recordTypeValue.trim() === '') return false;
                  
                  const match = recordTypeData.parsedData.find(ref =>
                    ref.Name && ref.Name.toString().trim() === recordTypeValue.toString().trim()
                  );
                  return !match; // Return true if no match found
                });
                
                if (notFoundRecords.length > 0) {
                  const exampleValues = notFoundRecords.slice(0, 3).map(r => `"${r[recordTypeData.columnName]}"`).join(', ');
                  setValidationErrors(prev => ({
                    ...prev,
                    step5_recordTypeNotFound: {
                      type: 'error',
                      message: `RecordType has ${notFoundRecords.length} unmatched value(s). Examples: ${exampleValues}. Please update your data.`
                    }
                  }));
                  return { hasWarning: false, canProceed: false };
                }
              }
              
              // Check other lookup fields - only validate if a field has data in CSV
              const lookupsWithMissingData = lookupFields.filter(lookup => {
                // Skip if no fieldName is selected (user just added field but didn't configure it)
                if (!lookup.fieldName || lookup.fieldName.trim() === '') return false;
                
                // Check if this lookup field has actual data in the CSV
                const hasData = csvData.some(row => row[lookup.fieldName] && row[lookup.fieldName].trim() !== '');
                
                // Only require parsedData if the field has data in the CSV
                if (hasData && !lookup.parsedData) {
                  return true;
                }
                
                return false;
              });
              
              if (lookupsWithMissingData.length > 0) {
                const fieldNames = lookupsWithMissingData.map(l => l.fieldName || 'Unnamed field').join(', ');
                setValidationErrors(prev => ({
                  ...prev,
                  step5_lookupMissing: {
                    type: 'error',
                    message: `Please provide SOQL query results for lookup field(s): ${fieldNames}`
                  }
                }));
                return { hasWarning: false, canProceed: false };
              }
              
              // Check for NOT FOUND values in other lookup fields
              for (const lookup of lookupFields) {
                if (!lookup.fieldName || !lookup.parsedData) continue;
                
                const notFoundRecords = csvData.filter(row => {
                  const lookupValue = row[lookup.fieldName];
                  if (!lookupValue || lookupValue.trim() === '') return false;
                  
                  const match = lookup.parsedData.find(ref =>
                    ref[lookup.lookupColumn] && 
                    ref[lookup.lookupColumn].toString().trim() === lookupValue.toString().trim()
                  );
                  return !match; // Return true if no match found
                });
                
                if (notFoundRecords.length > 0) {
                  const exampleValues = notFoundRecords.slice(0, 3).map(r => `"${r[lookup.fieldName]}"`).join(', ');
                  setValidationErrors(prev => ({
                    ...prev,
                    [`step5_lookupNotFound_${lookup.fieldName}`]: {
                      type: 'error',
                      message: `Lookup field "${lookup.fieldName}" has ${notFoundRecords.length} unmatched value(s). Examples: ${exampleValues}`
                    }
                  }));
                  return { hasWarning: false, canProceed: false };
                }
              }
            }
            
            // Step 6: Data Categories - validate if separate columns format is selected
            if (currentStep === 6) {
              if (dataCategoryConfig.format === 'columns' && dataCategoryConfig.columnMappings.length > 0) {
                // Validate that all mappings have both columns selected
                const incompleteMappings = dataCategoryConfig.columnMappings.filter(
                  m => !m.groupNameCol || !m.categoryNameCol
                );
                
                if (incompleteMappings.length > 0) {
                  setValidationErrors(prev => ({
                    ...prev,
                    step6_incomplete: {
                      type: 'error',
                      message: 'Please select both DataCategoryGroupName and DataCategoryName columns for all groups.'
                    }
                  }));
                  return { hasWarning: false, canProceed: false };
                }
                
                // Validate that each DataCategoryGroupName column has consistent values
                for (const mapping of dataCategoryConfig.columnMappings) {
                  const groupName = validateAndGetGroupName(mapping.groupNameCol, true);
                  if (!groupName) {
                    // validateAndGetGroupName already sets the error in validationErrors
                    return { hasWarning: false, canProceed: false };
                  }
                }
                
                // Validate that DataCategoryName columns don't have more than 8 categories
                for (const mapping of dataCategoryConfig.columnMappings) {
                  if (!mapping.categoryNameCol) continue;
                  
                  for (const row of csvData) {
                    const categoryValue = row[mapping.categoryNameCol];
                    if (categoryValue && categoryValue.trim() !== '') {
                      const categories = categoryValue.split('+').map(c => c.trim()).filter(c => c !== '');
                      if (categories.length > 8) {
                        setValidationErrors(prev => ({
                          ...prev,
                          [`step6_tooManyCategories_${mapping.categoryNameCol}`]: {
                            type: 'error',
                            message: `DataCategoryName column "${mapping.categoryNameCol}" has a value with ${categories.length} categories. Salesforce limit: maximum 8 data categories from a single group can be assigned to an article. Found: "${categoryValue.substring(0, 100)}${categoryValue.length > 100 ? '...' : ''}"`
                          }
                        }));
                        return { hasWarning: false, canProceed: false };
                      }
                    }
                  }
                }
              }
            }
            
            // Step 7: Channels - validate channel configuration
            if (currentStep === 7) {
              if (channelsConfig.mode === 'columns') {
                // User chose column mapping mode - at least one column should be mapped or they should switch to manual mode
                const hasMappedColumns = Object.values(channelsConfig.columnMappings).some(col => col && col.trim() !== '');
                
                if (!hasMappedColumns) {
                  setValidationErrors(prev => ({
                    ...prev,
                    step7_noChannels: {
                      type: 'warning',
                      message: 'No channel columns mapped and no manual channels selected. Articles will be visible in "application" channel by default.'
                    }
                  }));
                  if (!warningAcknowledged[`step${currentStep}`]) {
                    return { hasWarning: true, canProceed: false };
                  }
                }
              } else {
                // Manual mode - at least one channel should be selected
                const hasSelectedChannels = channelsConfig.application || channelsConfig.sites || channelsConfig.csp || channelsConfig.prm;
                
                if (!hasSelectedChannels) {
                  setValidationErrors(prev => ({
                    ...prev,
                    step7_noChannels: {
                      type: 'warning',
                      message: 'No channels selected. Articles will be visible in "application" channel by default.'
                    }
                  }));
                  if (!warningAcknowledged[`step${currentStep}`]) {
                    return { hasWarning: true, canProceed: false };
                  }
                }
              }
            }
            
            return { hasWarning: false, canProceed: true };
          };

          const handleImagesUpload = async (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const imagesMap = {};
            
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              // Extract refid and extension from filename
              // e.g., "0EMcp000002rB5p.png" -> refid: "0EMcp000002rB5p", ext: "png"
              const parts = file.name.split('.');
              const extension = parts.pop();
              const refid = parts.join('.');
              
              // Read file as data URL for inclusion in ZIP
              const reader = new FileReader();
              await new Promise((resolve) => {
                reader.onload = (e) => {
                  imagesMap[refid] = {
                    filename: file.name,
                    extension: extension,
                    content: new Uint8Array(e.target.result)
                  };
                  resolve();
                };
                reader.readAsArrayBuffer(file);
              });
            }
            
            setUploadedImages(imagesMap);
          };

          const transformHtmlWithLocalImages = (htmlContent) => {
            if (!htmlContent) return htmlContent;
            
            // Replace Salesforce image URLs with relative path to images folder
            // HTML files will be in 'data/' folder, images in 'data/images/' folder
            // So relative path from HTML file is: images/{refid}.{ext}
            // Handle both & and &amp; in URLs
            let transformed = htmlContent.replace(
              /<img([^>]+)src=["']([^"']*rtaImage[^"']*)["']([^>]*)>/gi,
              (match, before, url, after) => {
                // Handle HTML-encoded ampersands (&amp;) by looking for either & or &amp;
                const refidMatch = url.match(/[?&](?:amp;)?refid=([^&\s"']+)/i);
                if (refidMatch) {
                  const refid = refidMatch[1];
                  // Get the actual file extension from uploaded images
                  const extension = uploadedImages[refid]?.extension || 'png';
                  // Use relative path from data/*.html to data/images/*.{ext}
                  return `<img${before}src="images/${refid}.${extension}"${after}>`;
                }
                return match;
              }
            );
            
            return transformed;
          };

          const parseDataCategorySelections = (selectionsText) => {
            if (!selectionsText) return {};
            const categoryMap = {};
            try {
              const recordsMatch = selectionsText.match(/records=\[(.*?)\]/s);
              if (!recordsMatch) return {};
              const recordsText = recordsMatch[1];
              const records = recordsText.split(/\},\s*\{attributes=/);
              records.forEach(record => {
                const groupMatch = record.match(/DataCategoryGroupName=([^,}\s]+)/);
                const categoryMatch = record.match(/DataCategoryName=([^,}\s]+)/);
                if (groupMatch && categoryMatch) {
                  const groupName = groupMatch[1].trim();
                  const categoryName = categoryMatch[1].trim();
                  if (!categoryMap[groupName]) categoryMap[groupName] = [];
                  categoryMap[groupName].push(categoryName);
                }
              });
              Object.keys(categoryMap).forEach(group => {
                categoryMap[group] = categoryMap[group].join('+');
              });
            } catch (error) {
              console.error('Error parsing data category selections:', error);
            }
            return categoryMap;
          };

          const transformFlattenedDataCategories = (data, headers) => {
            // Check if this CSV has flattened DataCategorySelections columns
            const dataCatColumns = headers.filter(h => h.startsWith('DataCategorySelections.records.'));
            
            if (dataCatColumns.length === 0) {
              return { data, headers }; // No transformation needed
            }
            
            // Transform each row
            const transformedData = data.map(row => {
              const newRow = { ...row };
              const categoryGroups = {};
              
              // Parse all DataCategorySelections columns
              dataCatColumns.forEach(col => {
                // Extract index and field name from column like:
                // DataCategorySelections.records.0.DataCategoryGroupName
                // DataCategorySelections.records.0.DataCategoryName
                const match = col.match(/DataCategorySelections\.records\.(\d+)\.(DataCategoryGroupName|DataCategoryName)/);
                
                if (match && row[col]) {
                  const index = match[1];
                  const fieldType = match[2];
                  const value = row[col].trim();
                  
                  if (!categoryGroups[index]) {
                    categoryGroups[index] = {};
                  }
                  
                  categoryGroups[index][fieldType] = value;
                }
                
                // Remove the original flattened column
                delete newRow[col];
              });
              
              // Group categories by DataCategoryGroupName
              const groupedCategories = {};
              Object.values(categoryGroups).forEach(item => {
                if (item.DataCategoryGroupName && item.DataCategoryName) {
                  const groupName = item.DataCategoryGroupName;
                  if (!groupedCategories[groupName]) {
                    groupedCategories[groupName] = [];
                  }
                  groupedCategories[groupName].push(item.DataCategoryName);
                }
              });
              
              // Add new columns in the format: datacategorygroup.Product = Laptop+Tablet
              Object.keys(groupedCategories).forEach(groupName => {
                const columnName = `datacategorygroup.${groupName}`;
                const categoryValue = groupedCategories[groupName].join('+');
                newRow[columnName] = categoryValue;
              });
              
              return newRow;
            });
            
            // Update headers - remove DataCategorySelections columns and add new ones
            let newHeaders = headers.filter(h => !h.startsWith('DataCategorySelections.'));
            
            // Find all unique datacategorygroup columns from the transformed data
            const categoryColumns = new Set();
            transformedData.forEach(row => {
              Object.keys(row).forEach(key => {
                if (key.startsWith('datacategorygroup.')) {
                  categoryColumns.add(key);
                }
              });
            });
            
            newHeaders = [...newHeaders, ...Array.from(categoryColumns)];
            
            return { data: transformedData, headers: newHeaders };
          };

          const handleCSVUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
              Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                  // Transform flattened DataCategorySelections columns if present
                  const transformed = transformFlattenedDataCategories(results.data, results.meta.fields);
                  
                  setCsvData(transformed.data);
                  setCsvHeaders(transformed.headers);
                  
                  // Detect rich text fields by analyzing row data (looking for HTML content)
                  const detectedRichText = transformed.headers.filter(columnName => {
                    // Exclude problematic columns
                    if (columnName === '_') return false; // Exclude columns named "_"
                    if (columnName === 'DataCategorySelections') return false; // Exclude DataCategorySelections column
                    if (columnName.endsWith('__r') && !columnName.includes('__r.')) return false; // Exclude columns ending with just __r
                    if (columnName.startsWith('datacategorygroup.')) return false; // Exclude data category columns
                    
                    // Sample rows to check if column contains HTML
                    // Check up to 50 rows or all rows if dataset is small, skipping empty cells
                    const sampleSize = Math.min(50, transformed.data.length);
                    let checkedNonEmptyCells = 0;
                    const maxNonEmptyCellsToCheck = 10; // Check at least 10 non-empty cells if available
                    
                    for (let i = 0; i < sampleSize && checkedNonEmptyCells < maxNonEmptyCellsToCheck; i++) {
                      const cellValue = transformed.data[i][columnName];
                      if (cellValue && typeof cellValue === 'string' && cellValue.trim() !== '') {
                        checkedNonEmptyCells++;
                        // Check if content looks like HTML (contains tags like <p>, <img>, <div>, etc.)
                        const htmlPattern = /<[a-z][\s\S]*>/i;
                        if (htmlPattern.test(cellValue)) {
                          return true;
                        }
                      }
                    }
                    return false;
                  });
                  setRichTextColumns(detectedRichText);
                  
                  // Auto-detect RecordType column
                  const recordTypeCol = transformed.headers.find(h => 
                    h !== '_' && 
                    h !== 'DataCategorySelections' && 
                    !(h.endsWith('__r') && !h.includes('__r.')) && 
                    h.toLowerCase().includes('recordtype') && 
                    (h.includes('.') || h.includes('__r'))
                  );
                  if (recordTypeCol) {
                    setRecordTypeData(prev => ({ ...prev, columnName: recordTypeCol, enabled: true }));
                  }
                  
                  // Auto-detect lookup fields (columns with __r. or relationship notation, excluding RecordType)
                  // Only include fields that have data in at least one row
                  const detectedLookups = transformed.headers.filter(h => {
                    if (h.toLowerCase().includes('recordtype')) return false; // Exclude RecordType
                    if (h.startsWith('datacategorygroup.')) return false; // Exclude data category columns
                    if (h === '_') return false; // Exclude columns named "_"
                    if (h === 'DataCategorySelections') return false; // Exclude DataCategorySelections column
                    if (h.endsWith('__r') && !h.includes('__r.')) return false; // Exclude columns ending with just __r (without .Name or .Field)
                    if (!h.includes('__r.') && !(h.includes('.') && h !== h.toLowerCase() && !h.toLowerCase().includes('date'))) return false;
                    
                    // Check if this field has data in any row
                    const hasData = transformed.data.some(row => row[h] && row[h].trim() !== '');
                    return hasData;
                  }).map(fieldName => {
                    // Determine suggested output column name
                    let outputColumn = fieldName;
                    if (fieldName.includes('__r.Name')) {
                      outputColumn = fieldName.replace('__r.Name', '__c');
                    } else if (fieldName.includes('__r.')) {
                      outputColumn = fieldName.split('__r.')[0] + '__c';
                    } else if (fieldName.endsWith('.Name')) {
                      outputColumn = fieldName.replace('.Name', 'Id');
                    }
                    
                    return {
                      fieldName: fieldName,
                      objectName: '', // Don't auto-suggest, user must enter
                      outputColumn: outputColumn,
                      pastedData: '',
                      parsedData: null,
                      lookupColumn: 'Name',
                      idColumn: 'Id'
                    };
                  });
                  setLookupFields(detectedLookups);
                  
                  // Auto-detect data category format
                  // Check for SF CLI format first (datacategorygroup.* columns - highest priority)
                  const dataCatGroupCols = transformed.headers.filter(h => h.startsWith('datacategorygroup.'));
                  
                  // Check for JSON format (but exclude datacategorygroup.* columns)
                  const dataCatCol = transformed.headers.find(h => 
                    !h.startsWith('datacategorygroup.') && 
                    (h.toLowerCase().includes('datacategoryselection') || h.toLowerCase().includes('datacategory'))
                  );
                  
                  if (dataCatGroupCols.length > 0) {
                    // Pre-formatted datacategorygroup.* columns detected (from SF CLI export)
                    // These are already in the correct format and don't need configuration
                    const groups = dataCatGroupCols.map(col => {
                      const groupName = col.replace('datacategorygroup.', '');
                      return {
                        groupName: groupName,
                        columnName: col
                      };
                    });
                    setDataCategoryGroups(groups);
                    // Mark as 'ready' format - no configuration needed
                    setDataCategoryConfig({ format: 'ready', selectionColumn: '', columnMappings: [] });
                  } else if (dataCatCol) {
                    // JSON format detected
                    setDataCategoryConfig({ format: 'json', selectionColumn: dataCatCol, columnMappings: [] });
                    const allGroups = new Set();
                    transformed.data.forEach(row => {
                      const selections = row[dataCatCol];
                      if (selections) {
                        const parsed = parseDataCategorySelections(selections);
                        Object.keys(parsed).forEach(group => allGroups.add(group));
                      }
                    });
                    setDataCategoryGroups(Array.from(allGroups).map(group => ({
                      groupName: group,
                      columnName: `datacategorygroup.${group}`
                    })));
                  }
                  
                  // Auto-detect translation columns
                  const languageCol = transformed.headers.find(h => 
                    h.toLowerCase() === 'language'
                  );
                  
                  if (languageCol) {
                    // Check if there are multiple unique languages
                    const uniqueLanguages = new Set();
                    transformed.data.forEach(row => {
                      if (row[languageCol] && row[languageCol].trim()) {
                        uniqueLanguages.add(row[languageCol].trim());
                      }
                    });
                    
                    if (uniqueLanguages.size > 1) {
                      // Multiple languages detected - translations present
                      const isMasterCol = transformed.headers.find(h => 
                        h.toLowerCase() === 'ismasterlanguage'
                      );
                      const articleNumCol = transformed.headers.find(h => 
                        h.toLowerCase() === 'articlenumber'
                      );
                      
                      setTranslationConfig({
                        hasTranslations: true,
                        languageColumn: languageCol,
                        isMasterLanguageColumn: isMasterCol || '',
                        articleNumberColumn: articleNumCol || '',
                        detectedLanguages: Array.from(uniqueLanguages)
                      });
                    }
                  }
                  
                  // Auto-detect channel columns
                  const channelColMap = {
                    application: transformed.headers.find(h => h.toLowerCase() === 'isvisibleinapp'),
                    csp: transformed.headers.find(h => h.toLowerCase() === 'isvisibleincsp'),
                    sites: transformed.headers.find(h => h.toLowerCase() === 'isvisibleinpkb'),
                    prm: transformed.headers.find(h => h.toLowerCase() === 'isvisibleinprm')
                  };
                  
                  // Check if any channel columns were detected
                  const hasChannelColumns = Object.values(channelColMap).some(col => col);
                  
                  if (hasChannelColumns) {
                    setChannelsConfig(prev => ({
                      ...prev,
                      mode: 'columns',
                      columnMappings: {
                        application: channelColMap.application || '',
                        csp: channelColMap.csp || '',
                        sites: channelColMap.sites || '',
                        prm: channelColMap.prm || ''
                      }
                    }));
                  }
                  
                  setStep(2);
                },
                error: (error) => showToast('‚ùå Error parsing CSV: ' + error.message, 'error')
              });
            }
          };

          const toggleRichTextColumn = (column) => {
            setRichTextColumns(prev => 
              prev.includes(column) ? prev.filter(c => c !== column) : [...prev, column]
            );
          };

          const parsePastedData = (pastedText) => {
            if (!pastedText || !pastedText.trim()) return null;
            
            try {
              const trimmedText = pastedText.trim();
              
              // Try to detect and parse JSON first
              if (trimmedText.startsWith('{') || trimmedText.startsWith('[')) {
                try {
                  const jsonData = JSON.parse(trimmedText);
                  
                  // Handle different JSON structures
                  let records = null;
                  
                  // If it's an object with a 'records' property (Salesforce API format)
                  if (jsonData.records && Array.isArray(jsonData.records)) {
                    records = jsonData.records;
                  }
                  // If it's directly an array
                  else if (Array.isArray(jsonData)) {
                    records = jsonData;
                  }
                  // If it's a single object, wrap it in an array
                  else if (typeof jsonData === 'object') {
                    records = [jsonData];
                  }
                  
                  if (records && records.length > 0) {
                    // Flatten nested objects (like Salesforce API responses)
                    const flattenedRecords = records.map(record => {
                      const flattened = {};
                      Object.keys(record).forEach(key => {
                        // Skip 'attributes' field from Salesforce API
                        if (key === 'attributes') return;
                        
                        // If the value is a simple type, add it directly
                        if (typeof record[key] !== 'object' || record[key] === null) {
                          flattened[key] = record[key];
                        }
                        // If it's an object (like nested relationships), flatten it
                        else if (!Array.isArray(record[key])) {
                          Object.keys(record[key]).forEach(nestedKey => {
                            if (nestedKey !== 'attributes') {
                              flattened[`${key}.${nestedKey}`] = record[key][nestedKey];
                            }
                          });
                        }
                      });
                      return flattened;
                    });
                    
                    return flattenedRecords;
                  }
                } catch (jsonError) {
                  // If JSON parsing fails, continue to CSV/TSV parsing
                  console.log('Not valid JSON, trying CSV/TSV parsing');
                }
              }
              
              // Try to parse as CSV/TSV
              const result = Papa.parse(trimmedText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
              });
              
              if (result.data && result.data.length > 0) {
                return result.data;
              }
              return null;
            } catch (error) {
              console.error('Error parsing pasted data:', error);
              return null;
            }
          };

          const trim18CharIdTo15 = (id) => {
            if (!id) return id;
            const idStr = id.toString().trim();
            if (idStr.length === 18) {
              return idStr.substring(0, 15);
            }
            return idStr;
          };

          const generateSoqlQuery = (objectName, fieldName, uniqueValues) => {
            if (!objectName) return '';
            
            if (uniqueValues && uniqueValues.length > 0) {
              const quotedValues = uniqueValues.map(v => `'${v.replace(/'/g, "\\'")}'`).join(', ');
              return `SELECT Id, Name FROM ${objectName} WHERE Name IN (${quotedValues})`;
            }
            
            return `SELECT Id, Name FROM ${objectName}`;
          };

          const handleRecordTypePaste = (pastedText) => {
            const parsed = parsePastedData(pastedText);
            setRecordTypeData(prev => ({
              ...prev,
              pastedData: pastedText,
              parsedData: parsed
            }));
          };

          const addLookupField = () => {
            setLookupFields(prev => [...prev, { 
              fieldName: '',
              objectName: '',
              outputColumn: '',
              pastedData: '',
              parsedData: null,
              lookupColumn: 'Name',
              idColumn: 'Id'
            }]);
          };

          const updateLookupField = (index, field, value) => {
            setLookupFields(prev => {
              const updated = [...prev];
              updated[index][field] = value;
              
              // If pasting data, parse it
              if (field === 'pastedData') {
                updated[index].parsedData = parsePastedData(value);
              }
              
              // Auto-suggest output column when field name changes
              if (field === 'fieldName' && value) {
                let suggestedOutput = value;
                if (value.includes('__r.Name')) {
                  suggestedOutput = value.replace('__r.Name', '__c');
                } else if (value.includes('__r.')) {
                  suggestedOutput = value.split('__r.')[0] + '__c';
                } else if (value.endsWith('.Name')) {
                  suggestedOutput = value.replace('.Name', 'Id');
                }
                updated[index].outputColumn = suggestedOutput;
                // Don't auto-suggest object name - user must enter it
              }
              
              return updated;
            });
          };

          const removeLookupField = (index) => {
            const field = lookupFields[index];
            
            // Check if field has data and was auto-detected (contains __r)
            if (field.fieldName && field.fieldName.includes('__r')) {
              const hasData = csvData.some(row => row[field.fieldName] && row[field.fieldName].trim() !== '');
              
              if (hasData) {
                // Add to removed fields list for UI warning
                setRemovedLookupFields(prev => {
                  if (!prev.includes(field.fieldName)) {
                    return [...prev, field.fieldName];
                  }
                  return prev;
                });
              }
            }
            
            setLookupFields(prev => prev.filter((_, i) => i !== index));
          };

          const getUniqueValuesFromColumn = (columnName) => {
            if (!csvData || !columnName) return [];
            
            const values = new Set();
            csvData.forEach(row => {
              const value = row[columnName];
              if (value && value.toString().trim()) {
                values.add(value.toString().trim());
              }
            });
            
            return Array.from(values).filter(v => v);
          };

          const generateLookupQuery = (index) => {
            const lookup = lookupFields[index];
            if (!lookup.fieldName || !lookup.objectName) return '';
            
            const uniqueValues = getUniqueValuesFromColumn(lookup.fieldName);
            return generateSoqlQuery(lookup.objectName, lookup.fieldName, uniqueValues);
          };

          const crc32 = (data) => {
            const table = [];
            for (let i = 0; i < 256; i++) {
              let c = i;
              for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
              table[i] = c;
            }
            let crc = 0 ^ (-1);
            for (let i = 0; i < data.length; i++) {
              crc = (crc >>> 8) ^ table[(crc ^ data[i]) & 0xFF];
            }
            return (crc ^ (-1)) >>> 0;
          };

          const createZipBlob = (files) => {
            const encoder = new TextEncoder();
            const localHeaders = [];
            const centralHeaders = [];
            let offset = 0;

            files.forEach(({ filename, content }) => {
              const filenameBytes = encoder.encode(filename);
              const contentBytes = typeof content === 'string' ? encoder.encode(content) : content;
              const crc = crc32(contentBytes);
              
              const localHeader = new Uint8Array(30 + filenameBytes.length);
              const lhView = new DataView(localHeader.buffer);
              lhView.setUint32(0, 0x04034b50, true);
              lhView.setUint16(4, 20, true);
              lhView.setUint16(6, 0, true);
              lhView.setUint16(8, 0, true);
              lhView.setUint16(10, 0, true);
              lhView.setUint16(12, 0, true);
              lhView.setUint32(14, crc, true);
              lhView.setUint32(18, contentBytes.length, true);
              lhView.setUint32(22, contentBytes.length, true);
              lhView.setUint16(26, filenameBytes.length, true);
              lhView.setUint16(28, 0, true);
              localHeader.set(filenameBytes, 30);
              
              localHeaders.push({
                header: localHeader, content: contentBytes, filename: filenameBytes,
                crc: crc, size: contentBytes.length, offset: offset
              });
              offset += localHeader.length + contentBytes.length;
            });

            const centralDirStart = offset;
            localHeaders.forEach(({ filename, crc, size, offset: localOffset }) => {
              const cdHeader = new Uint8Array(46 + filename.length);
              const cdView = new DataView(cdHeader.buffer);
              cdView.setUint32(0, 0x02014b50, true);
              cdView.setUint16(4, 20, true);
              cdView.setUint16(6, 20, true);
              cdView.setUint16(8, 0, true);
              cdView.setUint16(10, 0, true);
              cdView.setUint16(12, 0, true);
              cdView.setUint16(14, 0, true);
              cdView.setUint32(16, crc, true);
              cdView.setUint32(20, size, true);
              cdView.setUint32(24, size, true);
              cdView.setUint16(28, filename.length, true);
              cdView.setUint16(30, 0, true);
              cdView.setUint16(32, 0, true);
              cdView.setUint16(34, 0, true);
              cdView.setUint16(36, 0, true);
              cdView.setUint32(38, 0, true);
              cdView.setUint32(42, localOffset, true);
              cdHeader.set(filename, 46);
              centralHeaders.push(cdHeader);
              offset += cdHeader.length;
            });

            const centralDirSize = offset - centralDirStart;
            const eocd = new Uint8Array(22);
            const eocdView = new DataView(eocd.buffer);
            eocdView.setUint32(0, 0x06054b50, true);
            eocdView.setUint16(4, 0, true);
            eocdView.setUint16(6, 0, true);
            eocdView.setUint16(8, files.length, true);
            eocdView.setUint16(10, files.length, true);
            eocdView.setUint32(12, centralDirSize, true);
            eocdView.setUint32(16, centralDirStart, true);
            eocdView.setUint16(20, 0, true);

            const parts = [];
            localHeaders.forEach(({ header, content }) => {
              parts.push(header);
              parts.push(content);
            });
            centralHeaders.forEach(header => parts.push(header));
            parts.push(eocd);
            return new Blob(parts, { type: 'application/zip' });
          };

          const generateZipFile = async () => {
            try {
              const files = [];
              const processedData = csvData.map((row, index) => {
                const rowNumber = index + 2;
                const newRow = { ...row };
                
                // Handle RecordType lookup (mandatory, special handling)
                if (recordTypeData.enabled && recordTypeData.parsedData && recordTypeData.columnName) {
                  const recordTypeValue = row[recordTypeData.columnName];
                  if (recordTypeValue) {
                    const match = recordTypeData.parsedData.find(ref =>
                      ref.Name && ref.Name.toString().trim() === recordTypeValue.toString().trim()
                    );
                    if (match && match.Id) {
                      // Trim 18-char ID to 15-char for RecordType
                      newRow['RecordTypeId'] = trim18CharIdTo15(match.Id);
                    }
                  }
                  // Remove the original RecordType column
                  delete newRow[recordTypeData.columnName];
                }
                
                // Handle other lookup fields
                lookupFields.forEach(lookup => {
                  if (lookup.fieldName && lookup.parsedData && lookup.outputColumn && lookup.lookupColumn && lookup.idColumn) {
                    const lookupValue = row[lookup.fieldName];
                    
                    // Always delete the original lookup field column
                    delete newRow[lookup.fieldName];
                    
                    if (lookupValue) {
                      const match = lookup.parsedData.find(ref => 
                        ref[lookup.lookupColumn] && 
                        ref[lookup.lookupColumn].toString().trim() === lookupValue.toString().trim()
                      );
                      if (match && match[lookup.idColumn]) {
                        // Use the specified output column name
                        newRow[lookup.outputColumn] = match[lookup.idColumn];
                      }
                    }
                  }
                });
                
                // Handle removed lookup fields (columns with __r that were removed from configuration)
                // These should be renamed to __c and have empty data
                Object.keys(newRow).forEach(columnName => {
                  if (columnName.includes('__r.Name') || (columnName.includes('__r.') && columnName.endsWith('.Name'))) {
                    // Check if this column is still configured in lookupFields
                    const isConfigured = lookupFields.some(l => l.fieldName === columnName);
                    
                    if (!isConfigured) {
                      // Remove the old column
                      delete newRow[columnName];
                      
                      // Determine the output column name
                      let outputColumnName;
                      if (columnName.includes('__r.Name')) {
                        outputColumnName = columnName.replace('__r.Name', '__c');
                      } else if (columnName.endsWith('.Name')) {
                        outputColumnName = columnName.replace('.Name', 'Id');
                      }
                      
                      // Add empty column with new name
                      if (outputColumnName) {
                        newRow[outputColumnName] = '';
                      }
                    }
                  }
                });
                
                richTextColumns.forEach(column => {
                  if (row[column]) {
                    // Create separate folder for each rich text field at top level
                    // Remove __c suffix and use columnName_data format
                    let folderName = column.replace(/__c$/i, '').replace(/_/g, '');
                    folderName = folderName + '_data';
                    
                    let fileName;
                    
                    // Check if translations are enabled
                    if (translationConfig.hasTranslations && translationConfig.languageColumn && translationConfig.isMasterLanguageColumn && translationConfig.articleNumberColumn) {
                      const articleNumber = row[translationConfig.articleNumberColumn];
                      const language = row[translationConfig.languageColumn];
                      const isMaster = row[translationConfig.isMasterLanguageColumn];
                      
                      // Check if this is master language (true, 'true', 1, '1')
                      const isMasterValue = (isMaster === true || isMaster === 'true' || isMaster === 1 || isMaster === '1');
                      
                      if (isMasterValue) {
                        // Master language: columnname_data/file{articleNumber}.html
                        fileName = `${folderName}/File${articleNumber}.html`;
                      } else {
                        // Translation: columnname_data/file{articleNumber}/{language}.html
                        fileName = `${folderName}/File${articleNumber}/${language}.html`;
                      }
                    } else {
                      // No translations: use row number as before
                      fileName = `${folderName}/File${rowNumber}.html`;
                    }
                    
                    // Transform HTML to use relative image references (images/*.png)
                    const transformedHtml = transformHtmlWithLocalImages(row[column]);
                    
                    files.push({ filename: fileName, content: transformedHtml });
                    newRow[column] = fileName;
                  }
                });
                
                // Handle Data Categories
                if (dataCategoryConfig.format === 'json' && dataCategoryConfig.selectionColumn) {
                  const selectionsText = row[dataCategoryConfig.selectionColumn];
                  if (selectionsText) {
                    const categoryMap = parseDataCategorySelections(selectionsText);
                    delete newRow[dataCategoryConfig.selectionColumn];
                    dataCategoryGroups.forEach(group => {
                      newRow[group.columnName] = categoryMap[group.groupName] || '';
                    });
                  } else {
                    dataCategoryGroups.forEach(group => {
                      newRow[group.columnName] = '';
                    });
                  }
                } else if (dataCategoryConfig.format === 'columns' && dataCategoryConfig.columnMappings.length > 0) {
                  // Handle separate columns format
                  dataCategoryConfig.columnMappings.forEach((mapping, index) => {
                    if (mapping.groupNameCol && mapping.categoryNameCol) {
                      // Use the validated group name from dataCategoryGroups, not from the row
                      const groupName = dataCategoryGroups[index]?.groupName;
                      const categoryName = row[mapping.categoryNameCol] || '';
                      
                      // Remove the original columns
                      delete newRow[mapping.groupNameCol];
                      delete newRow[mapping.categoryNameCol];
                      
                      // Add the datacategorygroup column only if groupName exists
                      if (groupName) {
                        const outputColumn = `datacategorygroup.${groupName}`;
                        newRow[outputColumn] = categoryName;
                      }
                    }
                  });
                }
                
                // Add Channels column
                const selectedChannels = [];
                
                if (channelsConfig.mode === 'columns') {
                  // Use column mapping mode
                  if (channelsConfig.columnMappings.application && row[channelsConfig.columnMappings.application]) {
                    const value = row[channelsConfig.columnMappings.application].toString().toLowerCase();
                    if (value === 'true' || value === '1') selectedChannels.push('application');
                    delete newRow[channelsConfig.columnMappings.application]; // Remove original column
                  }
                  if (channelsConfig.columnMappings.csp && row[channelsConfig.columnMappings.csp]) {
                    const value = row[channelsConfig.columnMappings.csp].toString().toLowerCase();
                    if (value === 'true' || value === '1') selectedChannels.push('csp');
                    delete newRow[channelsConfig.columnMappings.csp]; // Remove original column
                  }
                  if (channelsConfig.columnMappings.sites && row[channelsConfig.columnMappings.sites]) {
                    const value = row[channelsConfig.columnMappings.sites].toString().toLowerCase();
                    if (value === 'true' || value === '1') selectedChannels.push('sites');
                    delete newRow[channelsConfig.columnMappings.sites]; // Remove original column
                  }
                  if (channelsConfig.columnMappings.prm && row[channelsConfig.columnMappings.prm]) {
                    const value = row[channelsConfig.columnMappings.prm].toString().toLowerCase();
                    if (value === 'true' || value === '1') selectedChannels.push('prm');
                    delete newRow[channelsConfig.columnMappings.prm]; // Remove original column
                  }
                } else {
                  // Use manual checkbox mode
                  if (channelsConfig.application) selectedChannels.push('application');
                  if (channelsConfig.sites) selectedChannels.push('sites');
                  if (channelsConfig.csp) selectedChannels.push('csp');
                  if (channelsConfig.prm) selectedChannels.push('prm');
                }
                
                newRow['Channels'] = selectedChannels.length > 0 ? selectedChannels.join('+') : 'application';
                
                // Handle translation columns
                if (translationConfig.hasTranslations) {
                  // Convert isMasterLanguage from true/false to 1/0
                  if (translationConfig.isMasterLanguageColumn && newRow[translationConfig.isMasterLanguageColumn] !== undefined) {
                    const value = newRow[translationConfig.isMasterLanguageColumn];
                    const isMasterValue = (value === true || value === 'true' || value === 1 || value === '1');
                    newRow[translationConfig.isMasterLanguageColumn] = isMasterValue ? '1' : '0';
                  }
                  
                  // ArticleNumber will be excluded from output columns later (don't delete it here as we need it for sorting)
                }
                
                return newRow;
              });
              
              // Build explicit column list for output CSV
              // Start with original headers
              let outputColumns = [...csvHeaders];
              
              // Remove RecordType column if it was processed, add RecordTypeId
              if (recordTypeData.enabled && recordTypeData.columnName) {
                outputColumns = outputColumns.filter(col => col !== recordTypeData.columnName);
                if (!outputColumns.includes('RecordTypeId')) {
                  outputColumns.unshift('RecordTypeId');
                }
              }
              
              // Remove original lookup columns and add output columns
              lookupFields.forEach(lookup => {
                if (lookup.fieldName && lookup.outputColumn) {
                  // Remove the original lookup field column
                  outputColumns = outputColumns.filter(col => col !== lookup.fieldName);
                  // Add the output column if not already present
                  if (!outputColumns.includes(lookup.outputColumn)) {
                    outputColumns.push(lookup.outputColumn);
                  }
                }
              });
              
              // Handle removed lookup fields - convert __r.Name columns to __c
              outputColumns = outputColumns.map(columnName => {
                if (columnName.includes('__r.Name') || (columnName.includes('__r.') && columnName.endsWith('.Name'))) {
                  // Check if this column is still configured in lookupFields
                  const isConfigured = lookupFields.some(l => l.fieldName === columnName);
                  
                  if (!isConfigured) {
                    // Convert to __c format
                    if (columnName.includes('__r.Name')) {
                      return columnName.replace('__r.Name', '__c');
                    } else if (columnName.endsWith('.Name')) {
                      return columnName.replace('.Name', 'Id');
                    }
                  }
                }
                return columnName;
              });
              
              // Remove data category columns and add output columns
              if (dataCategoryConfig.format === 'json' && dataCategoryConfig.selectionColumn) {
                outputColumns = outputColumns.filter(col => col !== dataCategoryConfig.selectionColumn);
                // Add data category group columns
                dataCategoryGroups.forEach(group => {
                  if (!outputColumns.includes(group.columnName)) {
                    outputColumns.push(group.columnName);
                  }
                });
              } else if (dataCategoryConfig.format === 'columns' && dataCategoryConfig.columnMappings.length > 0) {
                // Remove the original columns
                dataCategoryConfig.columnMappings.forEach(mapping => {
                  if (mapping.groupNameCol && mapping.categoryNameCol) {
                    outputColumns = outputColumns.filter(col => col !== mapping.groupNameCol && col !== mapping.categoryNameCol);
                  }
                });
                // Add data category group columns
                dataCategoryGroups.forEach(group => {
                  if (!outputColumns.includes(group.columnName)) {
                    outputColumns.push(group.columnName);
                  }
                });
              }
              
              // Remove channel mapping columns if in columns mode
              if (channelsConfig.mode === 'columns') {
                Object.values(channelsConfig.columnMappings).forEach(colName => {
                  if (colName) {
                    outputColumns = outputColumns.filter(col => col !== colName);
                  }
                });
              }
              
              // Add Channels column
              if (!outputColumns.includes('Channels')) {
                outputColumns.push('Channels');
              }
              
              // Filter out problematic columns from output CSV
              outputColumns = outputColumns.filter(col => {
                if (col === '_') return false; // Exclude columns named "_"
                if (col === 'DataCategorySelections') return false; // Exclude DataCategorySelections
                if (col === 'Id') return false; // Exclude Id column (new ID will be generated on import)
                if (col.endsWith('__r') && !col.includes('__r.')) return false; // Exclude columns ending with just __r
                // Exclude ArticleNumber column if translations are enabled
                if (translationConfig.hasTranslations && col === translationConfig.articleNumberColumn) return false;
                return true;
              });
              
              // Sort data for translations: master language first, then translations, grouped by ArticleNumber
              let sortedData = processedData;
              if (translationConfig.hasTranslations && translationConfig.articleNumberColumn && translationConfig.isMasterLanguageColumn) {
                sortedData = [...processedData].sort((a, b) => {
                  const aArticleNum = a[translationConfig.articleNumberColumn];
                  const bArticleNum = b[translationConfig.articleNumberColumn];
                  const aIsMaster = a[translationConfig.isMasterLanguageColumn];
                  const bIsMaster = b[translationConfig.isMasterLanguageColumn];
                  
                  // First, sort by ArticleNumber
                  if (aArticleNum !== bArticleNum) {
                    // Try to parse as numbers for proper numeric sorting
                    const aNum = parseFloat(aArticleNum);
                    const bNum = parseFloat(bArticleNum);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                      return aNum - bNum;
                    }
                    // Fall back to string comparison
                    return String(aArticleNum).localeCompare(String(bArticleNum));
                  }
                  
                  // Within same ArticleNumber, master language (1) comes before translations (0)
                  // Convert to numbers for comparison: master (1) should come first
                  const aMasterNum = (aIsMaster === '1' || aIsMaster === 1) ? 0 : 1;
                  const bMasterNum = (bIsMaster === '1' || bIsMaster === 1) ? 0 : 1;
                  return aMasterNum - bMasterNum;
                });
              }
              
              const csv = Papa.unparse(sortedData, {
                columns: outputColumns,
                header: true,
                delimiter: outputSettings.csvSeparator
              });
              
              const propertiesContent = `CSVEncoding=${outputSettings.csvEncoding}
DefaultHTMLEncoding=${outputSettings.htmlEncoding}
RTAEncoding=${outputSettings.htmlEncoding}
CSVSeparator=${outputSettings.csvSeparator}
DateFormat=${outputSettings.dateFormat}
DateTimeFormat=${outputSettings.dateTimeFormat}`;
              
              // Add uploaded images to each rich text column's images folder
              // Structure: columnName_data/images/*.png
              // HTML files in columnName_data/*.html reference images as: images/*.png (relative path)
              
              // Group images by column
              const imagesByColumn = {};
              imageReferences.forEach(imgRef => {
                if (!imagesByColumn[imgRef.column]) {
                  imagesByColumn[imgRef.column] = new Set();
                }
                imagesByColumn[imgRef.column].add(imgRef.refid);
              });
              
              // Add images to each column's folder
              Object.keys(imagesByColumn).forEach(column => {
                let folderName = column.replace(/__c$/i, '').replace(/_/g, '');
                folderName = folderName + '_data';
                
                imagesByColumn[column].forEach(refid => {
                  const img = uploadedImages[refid];
                  if (img) {
                    files.push({
                      filename: `${folderName}/images/${img.filename}`,
                      content: img.content
                    });
                  }
                });
              });
              
              files.unshift(
                { filename: 'properties.properties', content: propertiesContent },
                { filename: outputSettings.outputFilename, content: csv }
              );
              
              const zipBlob = createZipBlob(files);
              const url = URL.createObjectURL(zipBlob);
              const a = document.createElement('a');
              a.href = url;
              
              // Add timestamp to filename
              const timestamp = generateTimestamp();
              a.download = `salesforce-knowledge-import-${timestamp}.zip`;
              
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              
              showToast(`Successfully created ZIP with ${files.length} files!`, 'success');
            } catch (error) {
              showToast('‚ùå Error creating ZIP: ' + error.message, 'error');
              console.error(error);
            }
          };

          return (
            <div className="min-h-screen bg-gray-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 mb-6">
                  <div className="flex items-center gap-4 mb-4">
                    <div className="bg-sf-blue-500 text-white p-3 rounded-lg">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                      </svg>
                    </div>
                    <div>
                      <h1 className="text-3xl font-bold text-sf-blue-800">
                    Salesforce Knowledge Import Tool
                  </h1>
                      <p className="text-gray-600 text-sm mt-1">
                        Prepare Knowledge articles for import with images and data categories
                  </p>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <div className="flex items-center justify-between overflow-x-auto">
                    {steps.map((s, index) => {
                      const StepIcon = s.icon;
                      const isActive = step === s.number;
                      const isCompleted = step > s.number;
                      
                      return (
                        <React.Fragment key={s.number}>
                          <div 
                            className={`flex flex-col items-center min-w-fit group ${
                              isCompleted || s.number === step + 1 ? 'cursor-pointer' : 
                              isActive ? 'cursor-default' : 'cursor-not-allowed opacity-60'
                            }`}
                            onClick={() => handleStepClick(s.number)}
                            title={
                              isCompleted ? 'Click to go back to this step' :
                              s.number === step + 1 ? 'Click to proceed to next step' :
                              isActive ? 'Current step' : 'Complete previous steps first'
                            }
                          >
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center shadow-md transition-all ${
                              isCompleted ? 'bg-sf-success text-white group-hover:shadow-lg group-hover:scale-105' :
                              isActive ? 'bg-sf-blue-500 text-white' : 
                              s.number === step + 1 ? 'bg-gray-200 text-gray-500 group-hover:bg-gray-300 group-hover:scale-105' :
                              'bg-gray-200 text-gray-400'
                            }`}>
                              {isCompleted ? <Check size={24} /> : <StepIcon size={24} />}
                            </div>
                            <span className={`mt-2 text-sm font-medium ${
                              isActive ? 'text-sf-blue-600' : 
                              isCompleted || s.number === step + 1 ? 'text-gray-600' : 'text-gray-400'
                            }`}>
                              {s.title}
                            </span>
                          </div>
                          {index < steps.length - 1 && (
                            <div className={`flex-1 h-1 mx-4 ${
                              step > s.number ? 'bg-sf-success' : 'bg-gray-300'
                            }`} />
                          )}
                        </React.Fragment>
                      );
                    })}
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6" style={{minHeight: '400px'}}>
                  {step === 0 && (
                    <div className="space-y-5 max-w-6xl mx-auto">
                      <div className="text-center mb-6">
                        <h1 className="text-3xl font-bold text-sf-blue-600 mb-2">Welcome to Salesforce Knowledge Import Tool</h1>
                        <p className="text-base text-gray-600">A secure, client-side tool to prepare Knowledge articles for import</p>
                        <p className="text-sm text-sf-blue-700 font-semibold mt-2">
                          ‚ú® Supports Knowledge import with images, data categories, and translations
                        </p>
                      </div>

                      {/* Security Notice */}
                      <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-5 shadow-md">
                        <div className="flex items-center justify-center gap-3">
                          <svg className="h-8 w-8 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                          </svg>
                          <div className="text-center">
                            <h3 className="text-lg font-bold text-green-900">üîí 100% Secure & Private</h3>
                            <p className="text-sm text-green-800 mt-1">
                              All data processing happens in your browser. No data is sent to any server. Your data stays completely private.
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* What This Tool Does */}
                      <div className="bg-white border-2 border-purple-300 rounded-lg p-5">
                        <h2 className="text-lg font-bold text-purple-700 mb-3 flex items-center justify-center">
                          <span className="mr-2">üõ†Ô∏è</span> What This Tool Does
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">‚úÖ</span>
                            <span className="text-sm text-gray-700">Maps columns & processes rich text fields</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">üñºÔ∏è</span>
                            <span className="text-sm text-gray-700">Handles images with download scripts</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">üîó</span>
                            <span className="text-sm text-gray-700">Resolves lookups (RecordType & custom)</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">üè∑Ô∏è</span>
                            <span className="text-sm text-gray-700">Data categories (SF CLI, JSON, or separate columns)</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">üåç</span>
                            <span className="text-sm text-gray-700">Supports translations (multi-language articles)</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-purple-600 font-bold">üì°</span>
                            <span className="text-sm text-gray-700">Configures channels for article visibility</span>
                          </div>
                        </div>
                      </div>

                      {/* Prerequisites - Compact */}
                      <div className="bg-white border-2 border-sf-blue-300 rounded-lg p-4">
                        <h2 className="text-lg font-bold text-sf-blue-700 mb-3 flex items-center">
                          <span className="mr-2">üìã</span> Prerequisites
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                          <div className="bg-sf-blue-50 p-3 rounded">
                            <h3 className="font-semibold text-gray-800 mb-1">CSV File</h3>
                            <p className="text-xs text-gray-700">
                              <strong>Recommended:</strong> Export using SF CLI (see Step 1).<br/>
                              <strong>Alternative:</strong> DataLoader or other tools that support data categories.
                            </p>
                          </div>

                          <div className="bg-sf-blue-50 p-3 rounded">
                            <h3 className="font-semibold text-gray-800 mb-1">For Images <span className="text-xs text-gray-500">(Optional)</span></h3>
                            <p className="text-xs text-gray-700">
                              ‚Ä¢ Salesforce CLI for auth<br/>
                              ‚Ä¢ Python or Bash to run scripts
                            </p>
                          </div>

                          <div className="bg-sf-blue-50 p-3 rounded">
                            <h3 className="font-semibold text-gray-800 mb-1">Target Org Access</h3>
                            <p className="text-xs text-gray-700">
                              Run SOQL queries for RecordType and lookup field mappings.
                            </p>
                          </div>
                        </div>
                        
                        <div className="mt-3 bg-red-50 border border-red-200 rounded p-2">
                          <p className="text-xs text-red-800">
                            <strong>‚ö†Ô∏è Limitations:</strong> This tool does not currently support file field types.
                          </p>
                        </div>
                      </div>

                      {/* Image Support */}
                      <div className="bg-white border-2 border-blue-300 rounded-lg p-4">
                        <h2 className="text-lg font-bold text-blue-700 mb-3 flex items-center">
                          <span className="mr-2">üñºÔ∏è</span> Image Support
                        </h2>
                        
                        <p className="text-xs text-gray-700 mb-3">
                          This tool handles <strong>images embedded in rich text fields</strong>. Images are automatically detected, downloaded via SF CLI, and organized for Salesforce import.
                        </p>
                        
                        <div className="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                          <h3 className="font-semibold text-blue-900 mb-2 text-sm">üìã How Image Processing Works</h3>
                          <ul className="text-xs text-blue-800 list-disc list-inside ml-2 space-y-1">
                            <li><strong>Auto-detection</strong> - Tool scans HTML content and identifies all image references</li>
                            <li><strong>Download scripts</strong> - Generates Bash/Python scripts using Salesforce CLI to download images</li>
                            <li><strong>Upload images</strong> - After downloading, upload image files back to the tool</li>
                            <li><strong>Path transformation</strong> - Updates HTML to use relative paths (e.g., <code className="bg-white px-1 rounded">images/refid.png</code>)</li>
                            <li><strong>Organization</strong> - Each rich text field gets its own images subfolder</li>
                          </ul>
                        </div>
                        
                        <div className="bg-white border border-blue-300 rounded p-3 mb-3">
                          <h3 className="font-semibold text-gray-800 mb-2 text-sm">Supported Image Formats:</h3>
                          <div className="flex gap-2 flex-wrap">
                            <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">.png</span>
                            <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">.jpg / .jpeg</span>
                            <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">.gif</span>
                          </div>
                          <p className="text-xs text-gray-600 mt-2 italic">
                            üí° Maximum file size: 1 MB per image (Salesforce limit)
                          </p>
                        </div>
                        
                        <div className="bg-green-50 border border-green-200 rounded p-3">
                          <h3 className="font-semibold text-green-900 mb-2 text-sm">‚ú® What This Tool Does:</h3>
                          <ul className="text-xs text-green-800 list-disc list-inside ml-2 space-y-1">
                            <li><strong>Extracts</strong> all image references from HTML content</li>
                            <li><strong>Creates</strong> SF CLI download scripts (Bash & Python)</li>
                            <li><strong>Organizes</strong> images in correct folder structure for import</li>
                            <li><strong>Transforms</strong> image URLs to relative paths in HTML</li>
                            <li><strong>Validates</strong> uploaded images match detected references</li>
                          </ul>
                        </div>
                      </div>

                      {/* Translation Support */}
                      <div className="bg-white border-2 border-purple-300 rounded-lg p-4">
                        <h2 className="text-lg font-bold text-purple-700 mb-3 flex items-center">
                          <span className="mr-2">üåç</span> Translation Support
                        </h2>
                        
                        <p className="text-xs text-gray-700 mb-3">
                          This tool supports importing Knowledge articles with <strong>multiple language translations</strong>. Articles and their translations are automatically organized for proper import.
                        </p>
                        
                        <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-3">
                          <h3 className="font-semibold text-purple-900 mb-2 text-sm">üìã Required Columns for Translations</h3>
                          <p className="text-xs text-purple-800 mb-2">
                            If your CSV contains articles in multiple languages, these columns are <strong>mandatory</strong>:
                          </p>
                          <ul className="text-xs text-purple-800 list-disc list-inside ml-2 space-y-1">
                            <li><strong>Language</strong> - The language code for each article (e.g., en, fr, es, de)</li>
                            <li><strong>isMasterLanguage</strong> - Identifies if the article is the primary (true) or translation (false)</li>
                            <li><strong>ArticleNumber</strong> - Groups the same article across different languages (e.g., all versions of Article 1 have ArticleNumber = 1)</li>
                          </ul>
                        </div>
                        
                        <div className="bg-white border border-purple-300 rounded p-3 mb-3">
                          <h3 className="font-semibold text-gray-800 mb-2 text-sm">Example CSV Structure:</h3>
                          <div className="bg-gray-100 rounded p-2 overflow-x-auto">
                            <table className="text-xs font-mono border-collapse w-full">
                              <thead>
                                <tr className="border-b-2 border-gray-400 bg-gray-200">
                                  <th className="px-2 py-1 text-left">Title</th>
                                  <th className="px-2 py-1 text-left text-purple-700">ArticleNumber</th>
                                  <th className="px-2 py-1 text-left text-purple-700">Language</th>
                                  <th className="px-2 py-1 text-left text-purple-700">isMasterLanguage</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr className="border-b border-gray-300">
                                  <td className="px-2 py-1">How to Reset Password</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">1</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">en</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">true</td>
                                </tr>
                                <tr className="border-b border-gray-300">
                                  <td className="px-2 py-1">Comment r√©initialiser le mot de passe</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">1</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">fr</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">false</td>
                                </tr>
                                <tr className="border-b border-gray-300">
                                  <td className="px-2 py-1">C√≥mo restablecer la contrase√±a</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">1</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">es</td>
                                  <td className="px-2 py-1 text-purple-700 font-semibold">false</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                        
                        <div className="bg-green-50 border border-green-200 rounded p-3">
                          <h3 className="font-semibold text-green-900 mb-2 text-sm">‚ú® What This Tool Does:</h3>
                          <ul className="text-xs text-green-800 list-disc list-inside ml-2 space-y-1">
                            <li><strong>Auto-detects</strong> translations when multiple languages are present</li>
                            <li><strong>Organizes HTML files</strong> - Master: <code className="bg-white px-1 rounded">Answer_data/File1.html</code>, Translations: <code className="bg-white px-1 rounded">Answer_data/File1/fr.html</code></li>
                            <li><strong>Sorts rows</strong> - Master language row first, followed by translations (required by Salesforce)</li>
                            <li><strong>Converts isMasterLanguage</strong> - true/false ‚Üí 1/0 in output CSV</li>
                            <li><strong>Removes ArticleNumber</strong> from output CSV (used only for grouping)</li>
                          </ul>
                        </div>
                      </div>

                      {/* Data Category Format - Compact */}
                      <div className="bg-white border-2 border-orange-300 rounded-lg p-4">
                        <h2 className="text-lg font-bold text-orange-700 mb-3 flex items-center">
                          <span className="mr-2">üìä</span> Data Category Format Support
                        </h2>
                        
                        <p className="text-xs text-gray-700 mb-3">
                          This tool supports data categories in <strong>three formats</strong>:
                        </p>
                        <ul className="text-xs text-gray-700 list-disc list-inside ml-2 space-y-1 mb-3">
                          <li className="text-green-700 font-semibold">‚ú® <strong>Option 1 - SF CLI Export (Recommended for migrations):</strong> Pre-formatted datacategorygroup.* columns - <em>no configuration needed!</em></li>
                          <li><strong>Option 2 - JSON Format:</strong> DataCategorySelections column from DataLoader export</li>
                          <li><strong>Option 3 - Separate Columns:</strong> Individual columns for DataCategoryGroupName and DataCategoryName</li>
                        </ul>

                        <div className="space-y-3">
                          <div className="bg-green-50 border-2 border-green-400 rounded p-3">
                            <div className="flex items-start gap-2 mb-2">
                              <span className="text-lg">‚ú®</span>
                              <div className="flex-1">
                                <h3 className="font-bold text-green-900 mb-1 text-sm">Option 1: SF CLI Export (Recommended for Org-to-Org Migrations)</h3>
                                <p className="text-xs text-green-800 mb-2">
                                  <strong>This is the recommended approach for migrating Knowledge articles between Salesforce orgs.</strong> Use the SF CLI export scripts in Step 1 to automatically format data categories correctly.
                                </p>
                              </div>
                            </div>
                            <div className="bg-white border border-green-300 rounded p-2 overflow-x-auto mb-2">
                              <table className="text-xs font-mono border-collapse w-full">
                                <thead>
                                  <tr className="border-b-2 border-gray-400 bg-gray-100">
                                    <th className="px-2 py-1 text-left">Title</th>
                                    <th className="px-2 py-1 text-left text-green-700">datacategorygroup.Product</th>
                                    <th className="px-2 py-1 text-left text-green-700">datacategorygroup.Region</th>
                                    <th className="px-2 py-1 text-left text-green-700">datacategorygroup.Audience</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr className="border-b border-gray-300">
                                    <td className="px-2 py-1">Article 1</td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">Laptop+Tablet</td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">North_America</td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">Enterprise+SMB</td>
                                  </tr>
                                  <tr className="border-b border-gray-300">
                                    <td className="px-2 py-1">Article 2</td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">Desktop</td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                  </tr>
                                  <tr>
                                    <td className="px-2 py-1">Article 3</td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">Europe+Asia</td>
                                    <td className="px-2 py-1 text-green-700 font-semibold">All</td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                            <div className="bg-green-100 border border-green-300 rounded p-2">
                              <p className="text-xs text-green-900 mb-1">
                                <strong>‚úì Benefits:</strong>
                              </p>
                              <ul className="text-xs text-green-800 list-disc list-inside ml-2 space-y-0.5">
                                <li>Automatically formatted - no manual configuration needed!</li>
                                <li>Categories step is automatically skipped</li>
                                <li>Direct export from source org using SF CLI</li>
                                <li>Perfect for org-to-org migrations</li>
                              </ul>
                              <p className="text-xs text-green-900 mt-2">
                                üí° <strong>How to use:</strong> Generate export scripts in Step 1 with the query including <code className="bg-white px-1 rounded">(SELECT DataCategoryGroupName, DataCategoryName FROM DataCategorySelections)</code>
                              </p>
                            </div>
                          </div>

                          <div className="bg-gray-50 border border-gray-300 rounded p-3">
                            <h3 className="font-semibold text-gray-800 mb-2 text-sm">Option 2: JSON Format Example</h3>
                            <div className="bg-gray-100 border border-gray-300 rounded p-2 overflow-x-auto mb-2">
                              <pre className="text-xs font-mono text-gray-800 whitespace-pre-wrap break-all">{`{records=[
  {attributes={type=Knowledge__DataCategorySelection, ...}, 
   DataCategoryGroupName=Product, DataCategoryName=Laptop},
  {attributes={type=Knowledge__DataCategorySelection, ...}, 
   DataCategoryGroupName=Region, DataCategoryName=North_America}
], done=true, totalsize=2}`}</pre>
                            </div>
                            <div className="flex items-center justify-between mb-2">
                              <p className="text-xs text-gray-600 italic">
                                <strong>Example SOQL Query:</strong>
                              </p>
                              <button
                                onClick={() => handleCopyClick('soql_query', `SELECT Title, RecordType.Name, 
  (SELECT DataCategoryGroupName, 
          DataCategoryName 
   FROM DataCategorySelections) 
FROM Knowledge__kav 
WHERE PublishStatus = 'Online' 
  AND IsLatestVersion = true 
WITH DATA CATEGORY Product__c 
  BELOW Laptop__c`)}
                                className={`text-xs px-3 py-1 rounded font-medium transition-all ${
                                  copiedButton === 'soql_query'
                                    ? 'bg-green-500 text-white'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                              >
                                {copiedButton === 'soql_query' ? '‚úì Copied' : 'Copy'}
                              </button>
                            </div>
                            <code className="block bg-gray-800 text-green-400 p-2 rounded text-xs font-mono whitespace-pre-wrap break-all">
{`SELECT Title, RecordType.Name, 
  (SELECT DataCategoryGroupName, 
          DataCategoryName 
   FROM DataCategorySelections) 
FROM Knowledge__kav 
WHERE PublishStatus = 'Online' 
  AND IsLatestVersion = true 
WITH DATA CATEGORY Product__c 
  BELOW Laptop__c`}
                            </code>
                          </div>

                          <div className="bg-gray-50 border border-gray-300 rounded p-3">
                            <h3 className="font-semibold text-gray-800 mb-2 text-sm">Option 3: Separate Columns Example</h3>
                            <div className="bg-gray-100 border border-gray-300 rounded p-2 overflow-x-auto mb-2">
                              <table className="text-xs font-mono border-collapse w-full">
                                <thead>
                                  <tr className="border-b-2 border-gray-400 bg-gray-200">
                                    <th className="px-2 py-1 text-left">Title</th>
                                    <th className="px-2 py-1 text-left">ProductGroup</th>
                                    <th className="px-2 py-1 text-left">ProductCategories</th>
                                    <th className="px-2 py-1 text-left">RegionGroup</th>
                                    <th className="px-2 py-1 text-left">RegionCategories</th>
                                    <th className="px-2 py-1 text-left">AudienceGroup</th>
                                    <th className="px-2 py-1 text-left">AudienceCategories</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr className="border-b border-gray-300">
                                    <td className="px-2 py-1">Article 1</td>
                                    <td className="px-2 py-1">Product</td>
                                    <td className="px-2 py-1">Laptop+Tablet</td>
                                    <td className="px-2 py-1">Region</td>
                                    <td className="px-2 py-1">North_America</td>
                                    <td className="px-2 py-1">Audience</td>
                                    <td className="px-2 py-1">Enterprise+SMB</td>
                                  </tr>
                                  <tr className="border-b border-gray-300">
                                    <td className="px-2 py-1">Article 2</td>
                                    <td className="px-2 py-1">Product</td>
                                    <td className="px-2 py-1">Desktop</td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                  </tr>
                                  <tr className="border-b border-gray-300">
                                    <td className="px-2 py-1">Article 3</td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1">Region</td>
                                    <td className="px-2 py-1">Europe+Asia</td>
                                    <td className="px-2 py-1"></td>
                                    <td className="px-2 py-1"></td>
                                  </tr>
                                  <tr>
                                    <td className="px-2 py-1">Article 4</td>
                                    <td className="px-2 py-1">Product</td>
                                    <td className="px-2 py-1">Laptop+Desktop+Tablet+Server</td>
                                    <td className="px-2 py-1">Region</td>
                                    <td className="px-2 py-1">Global</td>
                                    <td className="px-2 py-1">Audience</td>
                                    <td className="px-2 py-1">All</td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                            <p className="text-xs text-gray-600 italic mb-1">
                              üí° Multiple categories per group separated by + (e.g., Laptop+Tablet+Desktop).
                            </p>
                            <p className="text-xs text-gray-600 italic mb-1">
                              üí° <strong>Salesforce Limits:</strong> Maximum 3 data category groups per article and up to 8 data categories from a single group can be assigned to an article. 
                              <a 
                                href="https://help.salesforce.com/s/articleView?id=service.category_whatis.htm&type=5" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="text-sf-blue-600 hover:text-sf-blue-700 underline ml-1"
                              >
                                Learn more
                              </a>
                            </p>
                            <p className="text-xs text-gray-600 italic">
                              üí° Note: __c is only needed for SOQL queries, not in the CSV data. Not all groups are required for every article.
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Learn More Link */}
                      <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                        <div className="flex items-center justify-center gap-2">
                          <svg className="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <p className="text-sm text-blue-800">
                            <strong>Learn more about Knowledge Article Import:</strong>
                          </p>
                          <a 
                            href="https://help.salesforce.com/s/articleView?id=service.knowledge_article_importer.htm&type=5" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-sm text-sf-blue-600 hover:text-sf-blue-700 underline font-semibold flex items-center gap-1"
                          >
                            Salesforce Documentation
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                          </a>
                        </div>
                      </div>

                      {/* Ready to Start */}
                      <div className="text-center p-4 bg-sf-blue-50 rounded-lg border-2 border-sf-blue-300">
                        <h3 className="text-lg font-bold text-sf-blue-800 mb-2">‚ú® Ready to Get Started?</h3>
                        <p className="text-sm text-gray-700">
                          Click "Next" to upload your CSV file. You can navigate between steps at any time by clicking on the step icons above.
                        </p>
                      </div>
                    </div>
                  )}

                  {step === 1 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Upload Your CSV File</h2>
                      
                      {/* Export Script Generator */}
                      <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-lg p-6">
                        <div className="flex items-start gap-3 mb-4">
                          <div className="flex-shrink-0 w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                            <Download size={20} className="text-white" />
                          </div>
                          <div className="flex-1">
                            <h3 className="text-lg font-bold text-purple-900 mb-2">
                              üì§ Option 1: Export CSV from Salesforce using SF CLI
                            </h3>
                            <p className="text-sm text-purple-800 mb-3">
                              Generate bash/python scripts to export Knowledge articles directly from your Salesforce org. The scripts automatically format data categories correctly for this tool.
                            </p>
                          </div>
                        </div>
                        
                        <div className="space-y-4 bg-white rounded-lg p-4 border border-purple-200">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Source Org Alias <span className="text-red-500">*</span>
                            </label>
                            <input
                              type="text"
                              value={exportConfig.sourceOrgAlias}
                              onChange={(e) => setExportConfig(prev => ({ ...prev, sourceOrgAlias: e.target.value }))}
                              placeholder="e.g., mySourceOrg"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                              Your Salesforce org alias (authenticate with: <code className="bg-gray-100 px-1 rounded">sf org login web --alias mySourceOrg</code>)
                            </p>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              SOQL Query <span className="text-red-500">*</span>
                            </label>
                            <textarea
                              value={exportConfig.soqlQuery}
                              onChange={(e) => setExportConfig(prev => ({ ...prev, soqlQuery: e.target.value }))}
                              rows={8}
                              placeholder="SELECT Title, RecordType.Name, ..."
                              className="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-xs focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <div className="mt-2 space-y-1">
                              <p className="text-xs text-amber-700 font-semibold">
                                ‚ö†Ô∏è This is a sample query. Update it based on your requirements.
                              </p>
                              <p className="text-xs text-gray-600">
                                üí° Include <code className="bg-gray-100 px-1 rounded">(SELECT DataCategoryGroupName, DataCategoryName FROM DataCategorySelections)</code> for data categories
                              </p>
                            </div>
                          </div>
                          
                          <div className="flex gap-3">
                            <button
                              onClick={() => {
                                const script = generateExportBashScript();
                                downloadScript(script, 'export-knowledge-articles.sh');
                                showToast('‚úì Bash script downloaded successfully!', 'success');
                              }}
                              className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md hover:shadow-lg transition-all font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50 disabled:shadow-none"
                              disabled={!exportConfig.sourceOrgAlias || !exportConfig.soqlQuery}
                            >
                              <Download size={20} />
                              Download Bash Script
                            </button>
                            <button
                              onClick={() => {
                                const script = generateExportPythonScript();
                                downloadScript(script, 'export-knowledge-articles.py');
                                showToast('‚úì Python script downloaded successfully!', 'success');
                              }}
                              className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md hover:shadow-lg transition-all font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50 disabled:shadow-none"
                              disabled={!exportConfig.sourceOrgAlias || !exportConfig.soqlQuery}
                            >
                              <Download size={20} />
                              Download Python Script
                            </button>
                          </div>
                          
                          {(!exportConfig.sourceOrgAlias || !exportConfig.soqlQuery) && (
                            <div className="bg-amber-50 border border-amber-200 rounded p-2">
                              <p className="text-xs text-amber-700 text-center">
                                ‚ö†Ô∏è Please enter Source Org Alias and SOQL Query above to download the scripts
                              </p>
                            </div>
                          )}
                          
                          <div className="bg-blue-50 border border-blue-200 rounded p-3">
                            <p className="text-xs text-blue-800 mb-3">
                              <strong>üìù How to run the scripts:</strong>
                            </p>
                            
                            <div className="space-y-3">
                              <div className="bg-white border border-blue-300 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                  <p className="text-xs font-semibold text-blue-900">1. Bash (Mac/Linux/WSL)</p>
                                  <button
                                    onClick={() => handleCopyClick('bash_export_cmd', 'chmod +x export-knowledge-articles-*.sh && ./export-knowledge-articles-*.sh')}
                                    className={`text-xs px-2 py-1 rounded font-medium transition-all ${
                                      copiedButton === 'bash_export_cmd'
                                        ? 'bg-green-500 text-white'
                                        : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                    }`}
                                  >
                                    {copiedButton === 'bash_export_cmd' ? '‚úì Copied' : 'Copy'}
                                  </button>
                                </div>
                                <code className="block bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-800">
                                  chmod +x export-knowledge-articles-*.sh && ./export-knowledge-articles-*.sh
                                </code>
                              </div>
                              
                              <div className="bg-white border border-blue-300 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                  <p className="text-xs font-semibold text-blue-900">2. Python (All platforms)</p>
                                  <button
                                    onClick={() => handleCopyClick('python_export_cmd', 'python3 export-knowledge-articles-*.py')}
                                    className={`text-xs px-2 py-1 rounded font-medium transition-all ${
                                      copiedButton === 'python_export_cmd'
                                        ? 'bg-green-500 text-white'
                                        : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                    }`}
                                  >
                                    {copiedButton === 'python_export_cmd' ? '‚úì Copied' : 'Copy'}
                                  </button>
                                </div>
                                <code className="block bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-800">
                                  python3 export-knowledge-articles-*.py
                                </code>
                              </div>
                              
                              <div className="bg-green-50 border border-green-300 rounded p-2">
                                <p className="text-xs text-green-800">
                                  <strong>3. After running:</strong> Return here and upload the generated <code className="bg-white px-1 rounded">KnowledgeArticles.csv</code> file below
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Divider */}
                      <div className="relative">
                        <div className="absolute inset-0 flex items-center">
                          <div className="w-full border-t border-gray-300"></div>
                        </div>
                        <div className="relative flex justify-center text-sm">
                          <span className="px-4 bg-white text-gray-500 font-medium">OR</span>
                        </div>
                      </div>
                      
                      {/* Upload Section */}
                      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-6">
                        <h3 className="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2">
                          <Upload size={20} />
                          üìÇ Option 2: Upload CSV from DataLoader or Other Tools
                        </h3>
                        <p className="text-sm text-blue-800 mb-4">
                          If you already have a CSV exported from DataLoader or other tools, upload it here.
                        </p>
                        <div className="border-2 border-dashed border-blue-400 rounded-lg p-12 text-center hover:border-blue-600 hover:bg-blue-100 transition-all cursor-pointer bg-white"
                             onClick={() => fileInputRef.current?.click()}>
                          <Upload className="mx-auto h-12 w-12 text-blue-600 mb-4" />
                          <p className="text-lg text-gray-700 mb-2 font-medium">
                            Click to select your CSV file
                          </p>
                          <p className="text-sm text-gray-500">
                            Supports CSV files from DataLoader, SF CLI, or other export tools
                          </p>
                          <input
                            ref={fileInputRef}
                            type="file"
                            accept=".csv"
                            onChange={handleCSVUpload}
                            style={{display: 'none'}}
                          />
                        </div>
                      </div>
                    </div>
                  )}

                  {step === 2 && csvData && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Review Detected Columns</h2>
                      <p className="text-gray-600">
                        We've detected {csvHeaders.length} columns. {richTextColumns.length} rich text columns found.
                      </p>
                      
                      {/* Validation Errors/Warnings */}
                      {Object.entries(validationErrors).filter(([key]) => key.startsWith('step2_')).map(([key, error], index) => (
                        <div
                          key={key}
                          ref={index === 0 ? validationErrorRef : null}
                          className={`rounded-lg p-4 ${
                            error.type === 'error' || typeof error === 'string'
                              ? 'bg-red-50 border-2 border-red-300'
                              : 'bg-yellow-50 border-2 border-yellow-300'
                          }`}
                        >
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              {(error.type === 'error' || typeof error === 'string') ? (
                                <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg className="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </div>
                            <div className="ml-3 flex-1">
                              <p className={`text-sm font-medium ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-800' : 'text-yellow-800'
                              }`}>
                                {(error.type === 'error' || typeof error === 'string') ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                              </p>
                              <p className={`mt-1 text-sm ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-700' : 'text-yellow-700'
                              }`}>
                                {typeof error === 'string' ? error : error.message}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      {/* Translation Detection */}
                      {translationConfig.hasTranslations && (
                        <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                          <div className="flex items-start gap-3 mb-3">
                            <svg className="w-6 h-6 text-purple-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                            </svg>
                            <div className="flex-1">
                              <h3 className="text-lg font-bold text-purple-900 mb-1">
                                üåç Translations Detected
                              </h3>
                              <p className="text-sm text-purple-800">
                                Found {translationConfig.detectedLanguages.length} language(s): <strong>{translationConfig.detectedLanguages.join(', ')}</strong>
                              </p>
                            </div>
                          </div>
                          
                          <div className="bg-white border border-purple-200 rounded p-3 space-y-2">
                            <div className="grid grid-cols-2 gap-2 text-sm">
                              <div>
                                <span className="text-gray-600">Language Column:</span>
                                <div className="font-mono font-semibold text-purple-700">{translationConfig.languageColumn || 'Not detected'}</div>
                              </div>
                              <div>
                                <span className="text-gray-600">isMasterLanguage Column:</span>
                                <div className={`font-mono font-semibold ${translationConfig.isMasterLanguageColumn ? 'text-green-700' : 'text-red-700'}`}>
                                  {translationConfig.isMasterLanguageColumn || '‚ùå Missing'}
                                </div>
                              </div>
                              <div>
                                <span className="text-gray-600">ArticleNumber Column:</span>
                                <div className={`font-mono font-semibold ${translationConfig.articleNumberColumn ? 'text-green-700' : 'text-red-700'}`}>
                                  {translationConfig.articleNumberColumn || '‚ùå Missing'}
                                </div>
                              </div>
                            </div>
                            
                            {translationConfig.isMasterLanguageColumn && translationConfig.articleNumberColumn && (
                              <div className="bg-green-50 border border-green-200 rounded p-2 mt-2">
                                <p className="text-xs text-green-800">
                                  ‚úì All required columns detected. HTML files will be organized by ArticleNumber and language.
                                </p>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {!translationConfig.hasTranslations && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                          <Check className="inline h-5 w-5 text-green-600 mr-2" />
                          <span className="font-semibold text-green-900">Ready to proceed!</span>
                        </div>
                      )}
                    </div>
                  )}

                  {step === 3 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Select Rich Text Columns</h2>
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üîç Auto-Detection</h3>
                        <p className="text-sm text-blue-800">
                          Columns containing HTML content (detected by analyzing the first few rows of data) are automatically identified as rich text fields.
                          You can toggle any column on or off below.
                        </p>
                        <p className="text-xs text-blue-700 mt-2 italic">
                          üí° Each rich text field will get its own folder{richTextColumns.length > 0 && (
                            <span> (e.g., {richTextColumns.map(col => {
                              const folderName = col.replace(/__c$/i, '').replace(/_/g, '') + '_data';
                              return folderName;
                            }).slice(0, 2).join(', ')}{richTextColumns.length > 2 ? ', ...' : ''})</span>
                          )} with its own images subfolder
                        </p>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {csvHeaders
                          .filter(header => {
                            // Exclude problematic columns from display
                            if (header === '_') return false;
                            if (header === 'DataCategorySelections') return false;
                            if (header.endsWith('__r') && !header.includes('__r.')) return false;
                            if (header.startsWith('datacategorygroup.')) return false;
                            return true;
                          })
                          .map((header) => (
                          <label key={header} className={`flex items-center p-4 border-2 rounded-lg cursor-pointer ${
                            richTextColumns.includes(header) ? 'border-sf-blue-400 bg-sf-blue-50' : 'border-gray-200'
                          }`}>
                            <input
                              type="checkbox"
                              checked={richTextColumns.includes(header)}
                              onChange={() => toggleRichTextColumn(header)}
                              className="h-5 w-5 text-sf-blue-600 rounded mr-3"
                            />
                            <div className="font-medium text-gray-900">{header}</div>
                          </label>
                        ))}
                      </div>
                    </div>
                  )}

                  {step === 4 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Download & Upload Images</h2>
                      
                      {/* Validation Errors/Warnings */}
                      {Object.entries(validationErrors).filter(([key]) => key.startsWith('step4_')).map(([key, error], index) => (
                        <div
                          key={key}
                          ref={index === 0 ? validationErrorRef : null}
                          className={`rounded-lg p-4 ${
                            error.type === 'error'
                              ? 'bg-red-50 border-2 border-red-300'
                              : 'bg-yellow-50 border-2 border-yellow-300'
                          }`}
                        >
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              {error.type === 'error' ? (
                                <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg className="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </div>
                            <div className="ml-3 flex-1">
                              <p className={`text-sm font-medium ${
                                error.type === 'error' ? 'text-red-800' : 'text-yellow-800'
                              }`}>
                                {error.type === 'error' ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                              </p>
                              <p className={`mt-1 text-sm ${
                                error.type === 'error' ? 'text-red-700' : 'text-yellow-700'
                              }`}>
                                {error.message}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üìã How It Works</h3>
                        <ol className="list-decimal list-inside space-y-1 text-sm text-blue-800">
                          <li>Scan for images in your rich text content</li>
                          <li>Enter your Salesforce CLI org alias below</li>
                          <li>Download a pre-configured script (Bash or Python)</li>
                          <li>Run the script to download all images (authentication is automatic via SF CLI)</li>
                          <li>Upload the downloaded images back here</li>
                        </ol>
                        <p className="text-xs text-blue-700 mt-2 italic">
                          Images will be placed in data/images/ with relative paths for Salesforce import
                        </p>
                      </div>

                      {!imagesScanned ? (
                        <div className="text-center py-8">
                          <button 
                            onClick={scanAllImagesInCSV}
                            className="px-6 py-3 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold"
                          >
                            üîç Scan for Images
                          </button>
                          <p className="text-gray-500 mt-4">Click to scan rich text columns for Salesforce images</p>
                        </div>
                      ) : imageReferences.length === 0 ? (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                          <div className="text-blue-600 text-5xl mb-3">‚ÑπÔ∏è</div>
                          <h3 className="text-lg font-semibold text-blue-900 mb-2">No Images Detected</h3>
                          <p className="text-blue-800 mb-4">
                            Your rich text columns don't contain any Salesforce images (rtaImage URLs).
                          </p>
                          <div className="bg-white border border-blue-300 rounded-lg p-3 text-sm text-blue-900">
                            <p className="font-medium mb-1">‚úì This is okay!</p>
                            <p>You can proceed to the next step. Images are not required for Knowledge import.</p>
                          </div>
                        </div>
                      ) : (
                        <>
                          <div className="bg-gradient-to-r from-sf-blue-50 to-blue-50 border-2 border-sf-blue-200 rounded-lg p-4 shadow-sm">
                            <h3 className="font-semibold text-sf-blue-900 mb-3 flex items-center gap-2">
                              üîê Salesforce CLI Configuration
                            </h3>
                            <p className="text-sm text-sf-blue-800 mb-3">
                              Enter your Salesforce org alias. The scripts will use Salesforce CLI for automatic authentication.
                            </p>
                            
                            <div className="space-y-3">
                              <div>
                                <label className="block text-sm font-medium text-sf-blue-900 mb-1">
                                  Org Alias <span className="text-red-600">*</span>
                                </label>
                                <input
                                  type="text"
                                  value={orgAlias}
                                  onChange={(e) => setOrgAlias(e.target.value)}
                                  placeholder="e.g., my-sandbox, production"
                                  className="w-full px-3 py-2 border-2 border-sf-blue-300 rounded-md focus:border-sf-blue-500 focus:outline-none focus:ring-2 focus:ring-sf-blue-100 font-mono text-sm"
                                />
                              </div>
                              
                              <details className="bg-white rounded border border-sf-blue-200">
                                <summary className="px-3 py-2 cursor-pointer hover:bg-sf-blue-50 text-sm font-medium text-sf-blue-900">
                                  ‚ÑπÔ∏è How to find or create your org alias
                                </summary>
                                <div className="px-3 py-2 border-t border-sf-blue-200 text-xs text-sf-blue-800 space-y-2">
                                  <p><strong>Check existing orgs:</strong></p>
                                  <pre className="bg-gray-800 text-green-400 p-2 rounded overflow-x-auto">sf org list</pre>
                                  
                                  <p><strong>Authenticate a new org:</strong></p>
                                  <pre className="bg-gray-800 text-green-400 p-2 rounded overflow-x-auto">sf org login web --alias my-sandbox --instance-url https://test.salesforce.com</pre>
                                  
                                  <p className="text-sf-blue-600 italic">
                                    Replace "my-sandbox" with any name you prefer!
                                  </p>
                                </div>
                              </details>
                              
                              <details className="bg-white rounded border border-amber-200">
                                <summary className="px-3 py-2 cursor-pointer hover:bg-amber-50 text-sm font-medium text-amber-900">
                                  ‚ö†Ô∏è Troubleshooting: Script errors
                                </summary>
                                <div className="px-3 py-2 border-t border-amber-200 text-xs text-amber-800 space-y-2">
                                  <p><strong>Error: "jq: parse error" or "Failed to get org information"</strong></p>
                                  <p>This means the org alias doesn't exist or you're not authenticated.</p>
                                  
                                  <p className="mt-2"><strong>Solution:</strong></p>
                                  <ol className="list-decimal list-inside space-y-1 ml-2">
                                    <li>Run <code className="bg-gray-100 px-1 rounded">sf org list</code> to see authenticated orgs</li>
                                    <li>Use the exact ALIAS from that list (case-sensitive)</li>
                                    <li>If not listed, authenticate: <code className="bg-gray-100 px-1 rounded">sf org login web --alias YOUR_ALIAS</code></li>
                                  </ol>
                                  
                                  <p className="mt-2"><strong>Verify authentication:</strong></p>
                                  <pre className="bg-gray-800 text-green-400 p-2 rounded overflow-x-auto">sf org display --target-org YOUR_ALIAS</pre>
                                  <p className="text-xs text-amber-600 italic">
                                    If this command works, the script will work too!
                                  </p>
                                </div>
                              </details>
                            </div>
                          </div>
                        
                        <div className="space-y-6">
                          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <Check className="inline h-5 w-5 text-green-600 mr-2" />
                            <span className="font-semibold text-green-900">
                              Found {imageReferences.length} unique image{imageReferences.length !== 1 ? 's' : ''}
                            </span>
                          </div>

                          <div className="bg-white border-2 border-green-200 rounded-lg p-4">
                            <h3 className="font-semibold text-green-900 mb-3">
                              üì• Step 1: Download Pre-Configured Script
                            </h3>
                            <p className="text-xs text-gray-600 mb-3 italic">
                              üí° Scripts are timestamped to avoid duplicates (e.g., download-images-2025-01-13-14-30-05.sh)
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="border border-gray-300 rounded-lg p-3">
                                <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                  üíª Bash Script
                                </h4>
                                <p className="text-xs text-gray-600 mb-3">
                                  For Mac, Linux, and WSL. Pre-configured with org alias: <strong className="text-sf-blue-600 font-mono">{orgAlias || 'YOUR_ORG_ALIAS'}</strong>
                                </p>
                                <button
                                  onClick={() => downloadScript(generateBashScript(), 'download-images.sh')}
                                  disabled={!orgAlias}
                                  className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md hover:shadow-lg transition-all font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none"
                                >
                                  <Download size={20} />
                                  Download Bash Script
                                </button>
                                {!orgAlias && (
                                  <p className="text-xs text-amber-600 mt-2">
                                    ‚ö†Ô∏è Enter org alias above first
                                  </p>
                                )}
                              </div>

                              <div className="border border-gray-300 rounded-lg p-3">
                                <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                  üêç Python Script
                                </h4>
                                <p className="text-xs text-gray-600 mb-3">
                                  Cross-platform. Pre-configured with org alias: <strong className="text-sf-blue-600 font-mono">{orgAlias || 'YOUR_ORG_ALIAS'}</strong>
                                </p>
                                <button
                                  onClick={() => downloadScript(generatePythonScript(), 'download-images.py')}
                                  disabled={!orgAlias}
                                  className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-md hover:shadow-lg transition-all font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none"
                                >
                                  <Download size={20} />
                                  Download Python Script
                                </button>
                                {!orgAlias && (
                                  <p className="text-xs text-amber-600 mt-2">
                                    ‚ö†Ô∏è Enter org alias above first
                                  </p>
                                )}
                              </div>
                            </div>
                          </div>

                          <div className="bg-white border-2 border-blue-200 rounded-lg p-4">
                            <h3 className="font-semibold text-blue-900 mb-3">
                              ‚ñ∂Ô∏è Step 2: Run the Script
                            </h3>
                            
                            <div className="space-y-3">
                              <div className="bg-white border border-blue-300 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                  <p className="text-xs font-semibold text-blue-900">Bash (Mac/Linux/WSL)</p>
                                  <button
                                    onClick={() => handleCopyClick('bash_images_cmd', 'chmod +x download-images-*.sh && ./download-images-*.sh')}
                                    className={`text-xs px-2 py-1 rounded font-medium transition-all ${
                                      copiedButton === 'bash_images_cmd'
                                        ? 'bg-green-500 text-white'
                                        : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                    }`}
                                  >
                                    {copiedButton === 'bash_images_cmd' ? '‚úì Copied' : 'Copy'}
                                  </button>
                                </div>
                                <code className="block bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-800">
                                  chmod +x download-images-*.sh && ./download-images-*.sh
                                </code>
                              </div>
                              
                              <div className="bg-white border border-blue-300 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                  <p className="text-xs font-semibold text-blue-900">Python (All platforms)</p>
                                  <button
                                    onClick={() => handleCopyClick('python_images_cmd', 'python3 download-images-*.py')}
                                    className={`text-xs px-2 py-1 rounded font-medium transition-all ${
                                      copiedButton === 'python_images_cmd'
                                        ? 'bg-green-500 text-white'
                                        : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                    }`}
                                  >
                                    {copiedButton === 'python_images_cmd' ? '‚úì Copied' : 'Copy'}
                                  </button>
                                </div>
                                <code className="block bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-800">
                                  python3 download-images-*.py
                                </code>
                              </div>
                              
                              <div className="bg-blue-50 border border-blue-200 rounded p-2">
                                <p className="text-xs text-blue-800">
                                  <strong>üí° Note:</strong> Replace * with your timestamp or use tab completion. The script will download all {imageReferences.length} images to a timestamped "Images-YYYY-MM-DD-HH-MM-SS" folder.
                                </p>
                              </div>
                            </div>
                          </div>

                          <div className="border-2 border-dashed border-sf-blue-300 rounded-lg p-6 bg-sf-blue-50">
                            <h3 className="font-semibold text-sf-blue-900 mb-3">üìÅ Step 3: Upload Downloaded Images</h3>
                            <p className="text-sm text-gray-600 mb-2">
                              After running the script, upload all downloaded image files here.
                            </p>
                            <p className="text-xs text-gray-500 mb-4 italic">
                              üí° Images will be saved in a timestamped folder (e.g., Images-2025-01-13-14-30-05) to avoid conflicts
                            </p>
                            {Object.keys(uploadedImages).length > 0 && (
                              <div className="text-sm text-green-700 font-medium mb-4">
                                ‚úì {Object.keys(uploadedImages).length} image{Object.keys(uploadedImages).length !== 1 ? 's' : ''} uploaded
                              </div>
                            )}
                            <input
                              ref={imagesInputRef}
                              type="file"
                              multiple
                              accept="image/*"
                              onChange={handleImagesUpload}
                              style={{display: 'none'}}
                            />
                            <button
                              onClick={() => imagesInputRef.current?.click()}
                              className="w-full px-4 py-3 border-2 border-sf-blue-500 text-sf-blue-700 rounded-lg hover:bg-sf-blue-100 font-medium shadow-sm hover:shadow-md transition-all"
                            >
                              <Upload className="inline h-5 w-5 mr-2" />
                              Select Image Files
                            </button>
                          </div>

                          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <AlertCircle className="inline h-5 w-5 text-yellow-600 mr-2" />
                            <div className="text-sm text-yellow-800">
                              <strong>Important Notes:</strong>
                              <ul className="list-disc list-inside mt-1 ml-2">
                                <li>Scripts auto-detect image format and save with correct extension</li>
                                <li>Supported formats: .png, .gif, .jpg/.jpeg (per Salesforce requirements)</li>
                                <li>Images named as {'{'}refid{'}'}.{'{'}ext{'}'} (e.g., 0EMcp000002rB5p.png)</li>
                                <li>Each image must be ‚â§ 1 MB</li>
                                <li>Each rich text field folder has its own images/ subfolder</li>
                                <li>HTML automatically updated with relative image references (images/refid.ext)</li>
                              </ul>
                            </div>
                          </div>
                          
                          {imageReferences.length > 100 && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                              <div className="text-sm text-blue-800">
                                <strong>üìä Large Batch Detected ({imageReferences.length} images)</strong>
                                <p className="mt-2">
                                  <strong>Recommended Approach:</strong>
                                </p>
                                <ul className="list-disc list-inside mt-1 ml-2">
                                  <li><strong>Up to 500 images:</strong> Can be downloaded in a single run (takes ~10-30 minutes)</li>
                                  <li><strong>500-1000 images:</strong> Should work but may take 30-60 minutes. Consider running during off-peak hours.</li>
                                  <li><strong>1000+ images:</strong> Scripts will work but consider:
                                    <ul className="list-circle list-inside ml-4 mt-1">
                                      <li>Running during off-peak hours to avoid API rate limits</li>
                                      <li>Monitoring progress in case of timeouts</li>
                                      <li>May take 1-2 hours depending on image sizes</li>
                                    </ul>
                                  </li>
                                </ul>
                                <p className="mt-2 font-semibold">
                                  ‚ÑπÔ∏è Scripts process images sequentially to respect Salesforce API limits and avoid rate limiting.
                                </p>
                              </div>
                            </div>
                          )}

                          {imageReferences.length > 0 && (
                            <details className="border border-gray-300 rounded-lg">
                              <summary className="px-4 py-3 cursor-pointer hover:bg-gray-50 font-medium">
                                View Image Details ({imageReferences.length} images)
                              </summary>
                              <div className="px-4 py-3 border-t border-gray-300 max-h-60 overflow-y-auto">
                                <div className="space-y-2">
                                  {imageReferences.map((img, i) => (
                                    <div key={i} className="text-xs font-mono bg-gray-50 p-2 rounded">
                                      <div className="text-sf-blue-600 font-semibold">{img.refid}.png</div>
                                      <div className="text-gray-500 truncate">{img.url}</div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </details>
                          )}
                        </div>
                        </>
                      )}
                    </div>
                  )}

                  {step === 5 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Configure Lookup Fields</h2>
                      
                      {/* Validation Errors/Warnings */}
                      {Object.entries(validationErrors).filter(([key]) => key.startsWith('step5_')).map(([key, error], index) => (
                        <div
                          key={key}
                          ref={index === 0 ? validationErrorRef : null}
                          className={`rounded-lg p-4 ${
                            error.type === 'error'
                              ? 'bg-red-50 border-2 border-red-300'
                              : 'bg-yellow-50 border-2 border-yellow-300'
                          }`}
                        >
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              {error.type === 'error' ? (
                                <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg className="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </div>
                            <div className="ml-3 flex-1">
                              <p className={`text-sm font-medium ${
                                error.type === 'error' ? 'text-red-800' : 'text-yellow-800'
                              }`}>
                                {error.type === 'error' ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                              </p>
                              <p className={`mt-1 text-sm ${
                                error.type === 'error' ? 'text-red-700' : 'text-yellow-700'
                              }`}>
                                {error.message}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üí° How It Works</h3>
                        <ol className="list-decimal list-inside space-y-1 text-sm text-blue-800">
                          <li>Copy the generated SOQL query</li>
                          <li>Execute it in your Salesforce org to get Id and Name data</li>
                          <li>Paste the query results back here (CSV/TSV or JSON format)</li>
                          <li>The tool will map Names to IDs automatically</li>
                        </ol>
                        <p className="text-xs text-blue-700 mt-2 italic">
                          ‚ú® Supports CSV/TSV from Developer Console, Workbench, or JSON from REST API/Postman
                        </p>
                      </div>

                      {/* RecordType Section (Mandatory) */}
                      <div className="border-2 border-purple-300 rounded-lg p-4 bg-purple-50">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="text-lg font-bold text-purple-900 flex items-center gap-2">
                            <span className="bg-purple-600 text-white px-2 py-1 rounded text-xs">MANDATORY</span>
                            RecordType Lookup
                          </h3>
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={recordTypeData.enabled}
                              onChange={(e) => setRecordTypeData(prev => ({ ...prev, enabled: e.target.checked }))}
                              className="h-5 w-5 text-purple-600 rounded"
                            />
                            <span className="text-sm font-medium text-purple-900">Enable</span>
                          </label>
                        </div>
                        
                        {recordTypeData.enabled && (
                          <div className="space-y-3">
                            <div className="bg-white rounded-lg p-3 border border-purple-200">
                              <label className="block text-sm font-semibold text-gray-800 mb-2">
                                Select RecordType Column from CSV
                                {recordTypeData.columnName && <span className="ml-2 text-green-600 text-xs">‚úì Auto-detected</span>}
                              </label>
                              <select
                                value={recordTypeData.columnName}
                                onChange={(e) => setRecordTypeData(prev => ({ ...prev, columnName: e.target.value }))}
                                className="w-full px-3 py-2 border border-purple-300 rounded-md"
                              >
                                <option value="">Select column...</option>
                                {csvHeaders.filter(h => 
                                  h.toLowerCase().includes('recordtype') || 
                                  h.toLowerCase().includes('record') && h.toLowerCase().includes('type')
                                ).map(h => 
                                  <option key={h} value={h}>{h}</option>
                                )}
                                <optgroup label="All Columns">
                                  {csvHeaders.filter(h => 
                                    !h.toLowerCase().includes('recordtype')
                                  ).map(h => 
                                    <option key={h} value={h}>{h}</option>
                                  )}
                                </optgroup>
                            </select>
                            </div>
                            
                            {recordTypeData.columnName && (
                              <div className="bg-white rounded-lg p-3 border border-purple-200">
                                <p className="text-sm font-semibold text-gray-800 mb-2">üìù Step 1: Copy this SOQL query</p>
                                <pre className="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto">
SELECT Id, Name FROM RecordType WHERE SObjectType = 'Knowledge__kav'
                                </pre>
                                <button
                                  onClick={() => handleCopyClick('recordtype-query', "SELECT Id, Name FROM RecordType WHERE SObjectType = 'Knowledge__kav'")}
                                  className={`mt-2 text-xs px-3 py-1 rounded transition-all ${
                                    copiedButton === 'recordtype-query'
                                      ? 'bg-green-500 text-white'
                                      : 'bg-purple-600 text-white hover:bg-purple-700 hover:shadow-md'
                                  }`}
                                >
                                  {copiedButton === 'recordtype-query' ? '‚úì Copied' : 'üìã Copy Query'}
                                </button>
                              </div>
                            )}
                            
                            <div className="bg-white rounded-lg p-3 border border-purple-200">
                              <p className="text-sm font-semibold text-gray-800 mb-2">üì• Step 2: Paste query results here</p>
                              <textarea
                                value={recordTypeData.pastedData}
                                onChange={(e) => handleRecordTypePaste(e.target.value)}
                                placeholder="Paste CSV/TSV or JSON results from Salesforce (must include Id and Name columns)"
                                className="w-full h-24 px-3 py-2 border border-purple-300 rounded-md font-mono text-xs"
                              />
                              {recordTypeData.parsedData && (
                                <p className="text-xs text-green-600 mt-2">
                                  ‚úì Parsed {recordTypeData.parsedData.length} RecordType(s)
                                </p>
                              )}
                            </div>
                            
                            {/* Preview for RecordType */}
                            {recordTypeData.parsedData && recordTypeData.columnName && csvData && (
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h5 className="text-sm font-semibold text-purple-900 mb-2">üîç Preview: RecordType Replacements</h5>
                                <div className="space-y-2">
                                  {(() => {
                                    // Find rows that have data in RecordType field
                                    const rowsWithData = csvData
                                      .map((row, index) => ({ row, originalIndex: index }))
                                      .filter(({ row }) => row[recordTypeData.columnName] && row[recordTypeData.columnName].trim() !== '');
                                    
                                    const previewRows = rowsWithData.slice(0, 4);
                                    const totalRowsWithData = rowsWithData.length;
                                    
                                    return (
                                      <>
                                        {previewRows.map(({ row, originalIndex }) => {
                                          const originalValue = row[recordTypeData.columnName];
                                          const match = recordTypeData.parsedData.find(ref =>
                                            ref.Name && ref.Name.toString().trim() === originalValue.toString().trim()
                                          );
                                          
                                          return (
                                            <div key={originalIndex} className="bg-white rounded p-2 text-xs">
                                              <div className="flex items-center gap-2 flex-wrap">
                                                <span className="text-gray-500">Row {originalIndex + 2}:</span>
                                                <code className="text-red-600">{recordTypeData.columnName} = "{originalValue}"</code>
                                                <span className="text-gray-400">‚Üí</span>
                                                <code className="text-green-600 font-semibold">
                                                  RecordTypeId = "{match ? trim18CharIdTo15(match.Id) : 'NOT FOUND'}"
                                                </code>
                                                {match && match.Id.length === 18 && (
                                                  <span className="text-xs text-purple-600">(trimmed to 15-char)</span>
                                                )}
                                              </div>
                                            </div>
                                          );
                                        })}
                                        {totalRowsWithData > 4 && (
                                          <p className="text-xs text-purple-700 italic">
                                            ... and {totalRowsWithData - 4} more rows with data
                                          </p>
                                        )}
                                        {totalRowsWithData === 0 && (
                                          <p className="text-xs text-gray-500 italic">
                                            No data found in this field
                                          </p>
                                        )}
                                      </>
                                    );
                                  })()}
                                </div>
                              </div>
                            )}
                            
                            <div className="bg-yellow-50 border border-yellow-200 rounded p-2">
                              <p className="text-xs text-yellow-800">
                                <strong>Note:</strong> Output column will be <code className="bg-white px-1 rounded">RecordTypeId</code> (15-char IDs)
                              </p>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Removed Lookup Fields Warning */}
                      {removedLookupFields.length > 0 && (
                        <div className="bg-orange-50 border-2 border-orange-300 rounded-lg p-4">
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              <svg className="w-5 h-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                              </svg>
                            </div>
                            <div className="ml-3 flex-1">
                              <p className="text-sm font-medium text-orange-800">
                                ‚ö†Ô∏è Removed Lookup Fields with Data
                              </p>
                              <p className="mt-1 text-sm text-orange-700">
                                The following auto-detected lookup field{removedLookupFields.length > 1 ? 's have' : ' has'} been removed. These lookup columns would be empty in the output CSV if the data is not mapped.
                              </p>
                              <ul className="mt-2 space-y-1">
                                {removedLookupFields.map((fieldName, idx) => (
                                  <li key={idx} className="text-sm text-orange-800 font-mono bg-orange-100 px-2 py-1 rounded">
                                    ‚Ä¢ {fieldName}
                                  </li>
                                ))}
                              </ul>
                              <button
                                onClick={() => setRemovedLookupFields([])}
                                className="mt-2 text-xs px-3 py-1 bg-orange-200 text-orange-800 rounded hover:bg-orange-300"
                              >
                                Dismiss
                              </button>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Other Lookup Fields */}
                      <div className="space-y-4">
                        <div className="flex justify-between items-center">
                          <h3 className="text-lg font-semibold text-gray-800">Other Lookup Fields</h3>
                          {lookupFields.length > 0 && (
                            <span className="text-sm text-green-600 font-medium">
                              {lookupFields.filter(l => l.fieldName.includes('__r')).length} auto-detected
                            </span>
                          )}
                        </div>
                        
                        {lookupFields.length > 0 && lookupFields.some(l => !l.objectName) && (
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <AlertCircle className="inline h-5 w-5 text-amber-600 mr-2" />
                            <span className="text-sm text-amber-800 font-medium">
                              Please enter Salesforce Object Names for all auto-detected fields to generate queries.
                            </span>
                          </div>
                        )}
                        
                        {lookupFields.length === 0 && (
                          <div className="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                            <p className="text-gray-500 mb-3">No lookup fields detected. Add one manually if needed.</p>
                            <button onClick={addLookupField} className="px-4 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all">
                              <Plus className="inline h-5 w-5 mr-2" />
                              Add Lookup Field
                            </button>
                          </div>
                        )}
                        
                        {lookupFields.map((lookup, originalIndex) => {
                          // Always show manually added lookup fields and auto-detected fields with data
                          const hasFieldNameSelected = lookup.fieldName && lookup.fieldName.trim() !== '';
                          const hasData = hasFieldNameSelected && csvData.some(row => row[lookup.fieldName] && row[lookup.fieldName].trim() !== '');
                          
                          return (
                          <div key={originalIndex} className="border-2 border-gray-300 rounded-lg p-4 space-y-3">
                            <div className="flex justify-between items-center">
                              <h4 className="font-semibold text-gray-800">
                                {lookup.fieldName ? `Lookup Field: ${lookup.fieldName}` : 'New Lookup Field (Not Configured)'}
                              </h4>
                              <button 
                                onClick={() => removeLookupField(originalIndex)} 
                                className="px-3 py-1 text-red-600 hover:bg-red-50 rounded border border-red-300 text-sm"
                              >
                                <X className="inline h-4 w-4 mr-1" />
                              Remove
                            </button>
                          </div>
                            
                            <div className="grid grid-cols-3 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                  Input Field (from CSV)
                                  {lookup.fieldName && lookup.fieldName.includes('__r') && <span className="ml-1 text-green-600">‚úì Auto-detected</span>}
                                </label>
                                <select 
                                  value={lookup.fieldName} 
                                  onChange={(e) => updateLookupField(originalIndex, 'fieldName', e.target.value)}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                >
                                  <option value="">Select field...</option>
                                  <optgroup label="Relationship Fields (auto-detected)">
                                    {csvHeaders.filter(h => h.includes('__r') || (h.includes('.') && !h.toLowerCase().includes('date'))).map(h => 
                                      <option key={h} value={h}>{h}</option>
                                    )}
                                  </optgroup>
                                  <optgroup label="All Other Fields">
                                    {csvHeaders.filter(h => !h.includes('__r') && (!h.includes('.') || h.toLowerCase().includes('date'))).map(h => 
                                      <option key={h} value={h}>{h}</option>
                                    )}
                                  </optgroup>
                              </select>
                                {hasFieldNameSelected && !hasData && (
                                  <p className="text-xs text-amber-600 mt-1 bg-amber-50 border border-amber-200 rounded p-2">
                                    ‚ö†Ô∏è <strong>No data found</strong> in this column. You can still configure it, but it won't be used in the output since there's no data to map.
                                  </p>
                                )}
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                  Salesforce Object
                                </label>
                                <input
                                  type="text"
                                  value={lookup.objectName}
                                  onChange={(e) => updateLookupField(originalIndex, 'objectName', e.target.value)}
                                  placeholder="e.g., Category__c"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                  Output Field API Name
                                </label>
                                <input
                                  type="text"
                                  value={lookup.outputColumn}
                                  onChange={(e) => updateLookupField(originalIndex, 'outputColumn', e.target.value)}
                                  placeholder="e.g., Category__c"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"
                                />
                              </div>
                            </div>
                            
                            {lookup.fieldName && lookup.objectName && (
                              <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                                <p className="text-sm font-semibold text-gray-800 mb-2">üìù Generated SOQL Query</p>
                                <pre className="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto mb-2">
{generateLookupQuery(originalIndex)}
                                </pre>
                                <button
                                  onClick={() => {
                                    const query = generateLookupQuery(originalIndex);
                                    handleCopyClick(`lookup-query-${originalIndex}`, query);
                                  }}
                                  className={`text-xs px-3 py-1 rounded transition-all ${
                                    copiedButton === `lookup-query-${originalIndex}`
                                      ? 'bg-green-500 text-white'
                                      : 'bg-green-600 text-white hover:bg-green-700 hover:shadow-md'
                                  }`}
                                >
                                  {copiedButton === `lookup-query-${originalIndex}` ? '‚úì Copied' : 'üìã Copy Query'}
                                </button>
                            </div>
                            )}
                            
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                üì• Paste Query Results (Id, Name columns)
                              </label>
                              <textarea
                                value={lookup.pastedData}
                                onChange={(e) => updateLookupField(originalIndex, 'pastedData', e.target.value)}
                                placeholder="Paste CSV/TSV or JSON results from Salesforce..."
                                className="w-full h-24 px-3 py-2 border border-gray-300 rounded-md font-mono text-xs"
                              />
                              {lookup.parsedData && (
                                <p className="text-xs text-green-600 mt-2">
                                  ‚úì Parsed {lookup.parsedData.length} record(s)
                                </p>
                          )}
                        </div>
                            
                            {/* Preview Section */}
                            {lookup.parsedData && lookup.fieldName && csvData && (
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h5 className="text-sm font-semibold text-purple-900 mb-2">üîç Preview: What Will Be Replaced</h5>
                                <div className="space-y-2">
                                  {(() => {
                                    // Find rows that have data in this lookup field
                                    const rowsWithData = csvData
                                      .map((row, index) => ({ row, originalIndex: index }))
                                      .filter(({ row }) => row[lookup.fieldName] && row[lookup.fieldName].trim() !== '');
                                    
                                    const previewRows = rowsWithData.slice(0, 4);
                                    const totalRowsWithData = rowsWithData.length;
                                    
                                    return (
                                      <>
                                        {previewRows.map(({ row, originalIndex }) => {
                                          const originalValue = row[lookup.fieldName];
                                          const match = lookup.parsedData.find(ref =>
                                            ref[lookup.lookupColumn] && 
                                            ref[lookup.lookupColumn].toString().trim() === originalValue.toString().trim()
                                          );
                                          
                                          return (
                                            <div key={originalIndex} className="bg-white rounded p-2 text-xs">
                                              <div className="flex items-center gap-2">
                                                <span className="text-gray-500">Row {originalIndex + 2}:</span>
                                                <code className="text-red-600">{lookup.fieldName} = "{originalValue}"</code>
                                                <span className="text-gray-400">‚Üí</span>
                                                <code className="text-green-600 font-semibold">
                                                  {lookup.outputColumn} = "{match ? match[lookup.idColumn] : 'NOT FOUND'}"
                                                </code>
                                              </div>
                                            </div>
                                          );
                                        })}
                                        {totalRowsWithData > 4 && (
                                          <p className="text-xs text-purple-700 italic">
                                            ... and {totalRowsWithData - 4} more rows with data
                                          </p>
                                        )}
                                        {totalRowsWithData === 0 && (
                                          <p className="text-xs text-gray-500 italic">
                                            No data found in this field
                                          </p>
                                        )}
                                      </>
                                    );
                                  })()}
                                </div>
                              </div>
                            )}
                          </div>
                          );
                        })}
                        
                        <button 
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            addLookupField();
                          }} 
                          className="w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-sf-blue-500 hover:text-sf-blue-700 hover:bg-sf-blue-50 transition-all"
                        >
                          <Plus size={20} /> Add Another Lookup Field
                      </button>
                      </div>
                    </div>
                  )}

                  {step === 6 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">
                        {dataCategoryConfig.format === 'ready' ? 'Data Categories Detected' : 'Configure Data Categories'}
                      </h2>
                      
                      {/* Show detected categories when format is 'ready' (from SF CLI export) */}
                      {dataCategoryConfig.format === 'ready' && (
                        <div className="space-y-4">
                          <div className="bg-green-50 border-2 border-green-400 rounded-lg p-6">
                            <div className="flex items-start gap-3 mb-4">
                              <div className="flex-shrink-0 w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                              </div>
                              <div className="flex-1">
                                <h3 className="text-lg font-bold text-green-900 mb-2">
                                  ‚úì Data Categories Already Configured
                                </h3>
                                <p className="text-sm text-green-800 mb-3">
                                  Your CSV was exported using SF CLI and already contains data categories in the correct format. No configuration needed!
                                </p>
                              </div>
                            </div>
                            
                            <div className="bg-white border border-green-300 rounded-lg p-4">
                              <p className="font-semibold text-green-900 mb-3">
                                üìä Detected {dataCategoryGroups.length} Data Category Group(s):
                              </p>
                              <div className="space-y-2">
                                {dataCategoryGroups.map((group, i) => (
                                  <div key={i} className="flex items-center gap-3 bg-green-50 border border-green-200 rounded p-3">
                                    <div className="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                      {i + 1}
                                    </div>
                                    <div className="flex-1">
                                      <div className="text-sm font-semibold text-gray-700 mb-1">Group Name:</div>
                                      <div className="text-base font-mono font-bold text-green-700">{group.groupName}</div>
                                    </div>
                                    <div className="flex-1">
                                      <div className="text-sm font-semibold text-gray-700 mb-1">Column Name:</div>
                                      <div className="text-base font-mono font-bold text-sf-blue-600">{group.columnName}</div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                            
                            <div className="bg-blue-50 border border-blue-300 rounded p-3 mt-4">
                              <p className="text-sm text-blue-800">
                                <strong>üí° Next Step:</strong> Click "Next" to proceed to Channels configuration.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Validation Errors/Warnings */}
                      {Object.entries(validationErrors).filter(([key]) => key.startsWith('step6_') || key.startsWith('dataCategory_')).map(([key, error], index) => (
                        <div
                          key={key}
                          ref={index === 0 ? validationErrorRef : null}
                          className={`rounded-lg p-4 ${
                            error.type === 'error' || typeof error === 'string'
                              ? 'bg-red-50 border-2 border-red-300'
                              : 'bg-yellow-50 border-2 border-yellow-300'
                          }`}
                        >
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              {(error.type === 'error' || typeof error === 'string') ? (
                                <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg className="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </div>
                            <div className="ml-3 flex-1">
                              <p className={`text-sm font-medium ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-800' : 'text-yellow-800'
                              }`}>
                                {(error.type === 'error' || typeof error === 'string') ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                              </p>
                              <p className={`mt-1 text-sm ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-700' : 'text-yellow-700'
                              }`}>
                                {typeof error === 'string' ? error : error.message}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üìä About Data Categories</h3>
                        <p className="text-sm text-blue-800 mb-2">
                          This tool supports two formats for data categories:
                        </p>
                        <ul className="text-xs text-blue-700 list-disc list-inside ml-2 space-y-1">
                          <li><strong>JSON Format:</strong> DataCategorySelections in JSON format (from DataLoader)</li>
                          <li><strong>Separate Columns:</strong> Individual columns for each category group and name</li>
                        </ul>
                        <p className="text-xs text-blue-600 mt-2 italic">
                          üí° <strong>Salesforce Limits:</strong> Maximum 3 data category groups per article and up to 8 data categories from a single group can be assigned to an article. 
                          <a 
                            href="https://help.salesforce.com/s/articleView?id=service.category_whatis.htm&type=5" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-sf-blue-700 hover:text-sf-blue-800 underline ml-1 font-semibold"
                          >
                            Learn more
                          </a>
                        </p>
                      </div>

                      {/* Format Selection */}
                      {!dataCategoryConfig.format && (
                        <div className="bg-white border-2 border-gray-300 rounded-lg p-6">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">Select Data Category Format</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button
                              onClick={() => {
                                setDataCategoryConfig({ format: 'json', selectionColumn: '', columnMappings: [] });
                                // Keep existing detected groups for JSON format
                              }}
                              className="p-4 border-2 border-gray-300 rounded-lg hover:border-sf-blue-500 hover:bg-sf-blue-50 transition-all text-left"
                            >
                              <div className="font-semibold text-gray-900 mb-2">üìã JSON Format</div>
                              <div className="text-sm text-gray-600">
                                Use this if you have a DataCategorySelections column in JSON format from DataLoader export
                              </div>
                            </button>
                            <button
                              onClick={() => {
                                setDataCategoryConfig({ format: 'columns', selectionColumn: '', columnMappings: [] });
                                setDataCategoryGroups([]); // Clear detected groups for separate columns format
                              }}
                              className="p-4 border-2 border-gray-300 rounded-lg hover:border-sf-blue-500 hover:bg-sf-blue-50 transition-all text-left"
                            >
                              <div className="font-semibold text-gray-900 mb-2">üìë Separate Columns</div>
                              <div className="text-sm text-gray-600">
                                Use this if you have separate columns for DataCategoryGroupName and DataCategoryName
                              </div>
                            </button>
                          </div>
                        </div>
                      )}

                      {/* JSON Format Configuration */}
                      {dataCategoryConfig.format === 'json' && (
                        <div className="bg-white border-2 border-gray-300 rounded-lg p-6 space-y-4">
                          <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-gray-800">JSON Format Configuration</h3>
                            <button
                              onClick={() => {
                                setDataCategoryConfig({ format: '', selectionColumn: '', columnMappings: [] });
                                setDataCategoryGroups([]);
                              }}
                              className="px-4 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold flex items-center gap-2"
                            >
                              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                              Change Format
                            </button>
                          </div>
                          <select 
                            value={dataCategoryConfig.selectionColumn} 
                              onChange={(e) => {
                              setDataCategoryConfig(prev => ({ ...prev, selectionColumn: e.target.value }));
                              
                              // Clear previous errors
                              setValidationErrors(prev => {
                                const newErrors = { ...prev };
                                delete newErrors.step6_invalidJsonColumn;
                                return newErrors;
                              });
                              
                                if (e.target.value) {
                                  const allGroups = new Set();
                                  csvData.forEach(row => {
                                    const selections = row[e.target.value];
                                    if (selections) {
                                      const parsed = parseDataCategorySelections(selections);
                                      Object.keys(parsed).forEach(group => allGroups.add(group));
                                    }
                                  });
                                  
                                  if (allGroups.size === 0) {
                                    // No groups detected - show error
                                    setValidationErrors(prev => ({
                                      ...prev,
                                      step6_invalidJsonColumn: {
                                        type: 'error',
                                        message: `Unable to detect DataCategoryGroupName from column "${e.target.value}". Please ensure the column contains valid JSON data category selections.`
                                      }
                                    }));
                                    setDataCategoryGroups([]);
                                  } else {
                                    setDataCategoryGroups(Array.from(allGroups).map(group => ({
                                      groupName: group,
                                      columnName: `datacategorygroup.${group}`
                                    })));
                                  }
                                }
                              }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md"
                          >
                        <option value="">Select DataCategorySelections column...</option>
                        {csvHeaders.map(header => <option key={header} value={header}>{header}</option>)}
                      </select>
                      {dataCategoryConfig.format === 'json' && dataCategoryGroups.length > 0 && (
                        <div className="bg-white border border-green-300 rounded-lg p-4">
                          <p className="font-semibold text-green-900 mb-3">
                            ‚úì Detected {dataCategoryGroups.length} Data Category Group(s):
                          </p>
                          <div className="space-y-2">
                            {dataCategoryGroups.map((group, i) => (
                              <div key={i} className="flex items-center gap-3 bg-green-50 border border-green-200 rounded p-3">
                                <div className="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                  {i + 1}
                                </div>
                                <div className="flex-1">
                                  <div className="text-sm font-semibold text-gray-700 mb-1">Group Name:</div>
                                  <div className="text-base font-mono font-bold text-green-700">{group.groupName}</div>
                                </div>
                                <div className="flex-1">
                                  <div className="text-sm font-semibold text-gray-700 mb-1">Output Column:</div>
                                  <div className="text-base font-mono font-bold text-sf-blue-600">{group.columnName}</div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                      {/* Separate Columns Format Configuration */}
                      {dataCategoryConfig.format === 'columns' && (
                        <div className="bg-white border-2 border-gray-300 rounded-lg p-6 space-y-4">
                          <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-gray-800">Separate Columns Configuration</h3>
                            <button
                              onClick={() => {
                                setDataCategoryConfig({ format: '', selectionColumn: '', columnMappings: [] });
                                setDataCategoryGroups([]);
                              }}
                              className="px-4 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold flex items-center gap-2"
                            >
                              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                              Change Format
                            </button>
                          </div>

                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                How many Data Category Groups do you have? (Max: 3)
                              </label>
                              <select
                                value={dataCategoryConfig.columnMappings.length || ''}
                                onChange={(e) => {
                                  const count = parseInt(e.target.value) || 0;
                                  const newMappings = Array(count).fill(null).map((_, i) => 
                                    dataCategoryConfig.columnMappings[i] || { groupNameCol: '', categoryNameCol: '' }
                                  );
                                  setDataCategoryConfig(prev => ({ ...prev, columnMappings: newMappings }));
                                }}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                              >
                                <option value="">Select number of groups...</option>
                                <option value="1">1 Group</option>
                                <option value="2">2 Groups</option>
                                <option value="3">3 Groups</option>
                              </select>
                            </div>

                            {dataCategoryConfig.columnMappings.map((mapping, index) => (
                              <div key={index} className="border-2 border-gray-200 rounded-lg p-4 space-y-3">
                                <h4 className="font-semibold text-gray-800">Data Category Group {index + 1}</h4>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    DataCategoryGroupName Column
                                  </label>
                                  <select
                                    value={mapping.groupNameCol}
                                    onChange={(e) => {
                                      const newMappings = [...dataCategoryConfig.columnMappings];
                                      newMappings[index] = { ...newMappings[index], groupNameCol: e.target.value };
                                      setDataCategoryConfig(prev => ({ ...prev, columnMappings: newMappings }));
                                      
                                      // Clear step6 errors when user makes changes
                                      setValidationErrors(prev => {
                                        const newErrors = { ...prev };
                                        Object.keys(newErrors).forEach(key => {
                                          if (key.startsWith('step6_') || key.startsWith('dataCategory_')) {
                                            delete newErrors[key];
                                          }
                                        });
                                        return newErrors;
                                      });
                                      
                                      // Update data category groups
                                      if (e.target.value && newMappings.every(m => m.groupNameCol && m.categoryNameCol)) {
                                        const groups = [];
                                        let hasError = false;
                                        
                                        for (const m of newMappings) {
                                          const groupName = validateAndGetGroupName(m.groupNameCol, true);
                                          if (!groupName) {
                                            hasError = true;
                                            break;
                                          }
                                          groups.push({
                                            groupName: groupName,
                                            columnName: `datacategorygroup.${groupName}`
                                          });
                                        }
                                        
                                        if (!hasError) {
                                          setDataCategoryGroups(groups);
                                        } else {
                                          setDataCategoryGroups([]);
                                        }
                                      }
                                    }}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  >
                                    <option value="">Select column...</option>
                                    {csvHeaders.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    DataCategoryName Column
                                  </label>
                                  <select
                                    value={mapping.categoryNameCol}
                                    onChange={(e) => {
                                      const newMappings = [...dataCategoryConfig.columnMappings];
                                      newMappings[index] = { ...newMappings[index], categoryNameCol: e.target.value };
                                      setDataCategoryConfig(prev => ({ ...prev, columnMappings: newMappings }));
                                      
                                      // Clear step6 errors when user makes changes
                                      setValidationErrors(prev => {
                                        const newErrors = { ...prev };
                                        Object.keys(newErrors).forEach(key => {
                                          if (key.startsWith('step6_') || key.startsWith('dataCategory_')) {
                                            delete newErrors[key];
                                          }
                                        });
                                        return newErrors;
                                      });
                                      
                                      // Update data category groups
                                      if (e.target.value && newMappings.every(m => m.groupNameCol && m.categoryNameCol)) {
                                        const groups = [];
                                        let hasError = false;
                                        
                                        for (const m of newMappings) {
                                          const groupName = validateAndGetGroupName(m.groupNameCol, true);
                                          if (!groupName) {
                                            hasError = true;
                                            break;
                                          }
                                          groups.push({
                                            groupName: groupName,
                                            columnName: `datacategorygroup.${groupName}`
                                          });
                                        }
                                        
                                        if (!hasError) {
                                          setDataCategoryGroups(groups);
                                        } else {
                                          setDataCategoryGroups([]);
                                        }
                                      }
                                    }}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  >
                                    <option value="">Select column...</option>
                                    {csvHeaders.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                  <p className="text-xs text-gray-500 mt-1 italic">
                                    üí° Values should be in format: Category1+Category2+Category3 (max 8 categories)
                                  </p>
                                </div>
                              </div>
                            ))}

                            {dataCategoryGroups.length > 0 && (
                              <div className="bg-white border border-green-300 rounded-lg p-4">
                                <p className="font-semibold text-green-900 mb-3">
                                  ‚úì Configured {dataCategoryGroups.length} Data Category Group(s):
                                </p>
                                <div className="space-y-2">
                                  {dataCategoryGroups.map((group, i) => (
                                    <div key={i} className="flex items-center gap-3 bg-green-50 border border-green-200 rounded p-3">
                                      <div className="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                        {i + 1}
                                      </div>
                                      <div className="flex-1">
                                        <div className="text-sm font-semibold text-gray-700 mb-1">Group Name:</div>
                                        <div className="text-base font-mono font-bold text-green-700">{group.groupName}</div>
                                      </div>
                                      <div className="flex-1">
                                        <div className="text-sm font-semibold text-gray-700 mb-1">Output Column:</div>
                                        <div className="text-base font-mono font-bold text-sf-blue-600">{group.columnName}</div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {step === 7 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Configure Channels</h2>
                      
                      {/* Validation Errors/Warnings */}
                      {Object.entries(validationErrors).filter(([key]) => key.startsWith('step7_')).map(([key, error], index) => (
                        <div
                          key={key}
                          ref={index === 0 ? validationErrorRef : null}
                          className={`rounded-lg p-4 ${
                            error.type === 'error' || typeof error === 'string'
                              ? 'bg-red-50 border-2 border-red-300'
                              : 'bg-yellow-50 border-2 border-yellow-300'
                          }`}
                        >
                          <div className="flex items-start">
                            <div className="flex-shrink-0">
                              {(error.type === 'error' || typeof error === 'string') ? (
                                <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg className="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </div>
                            <div className="ml-3 flex-1">
                              <p className={`text-sm font-medium ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-800' : 'text-yellow-800'
                              }`}>
                                {(error.type === 'error' || typeof error === 'string') ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                              </p>
                              <p className={`mt-1 text-sm ${
                                (error.type === 'error' || typeof error === 'string') ? 'text-red-700' : 'text-yellow-700'
                              }`}>
                                {typeof error === 'string' ? error : error.message}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üì° About Channels</h3>
                        <p className="text-sm text-blue-800 mb-2">
                          Channels specify where your Knowledge articles will be available in Salesforce.
                        </p>
                        <ul className="text-xs text-blue-700 list-disc list-inside ml-2 space-y-1">
                          <li>Select at least one channel for your articles</li>
                          <li>If no channel is selected, <strong>application</strong> (Internal App) will be used as default</li>
                          <li>Multiple channels will be combined with "+" (e.g., application+sites+csp)</li>
                        </ul>
                      </div>
                      
                      {/* Mode Selection */}
                      {channelsConfig.mode === 'columns' && (
                        <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <h3 className="text-lg font-bold text-green-900">‚úì Channel Columns Detected</h3>
                              <p className="text-sm text-green-800 mt-1">
                                Your CSV contains channel visibility columns. Using column mapping mode.
                              </p>
                            </div>
                            <button
                              onClick={() => setChannelsConfig(prev => ({ ...prev, mode: 'manual' }))}
                              className="px-4 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold text-sm"
                            >
                              Switch to Manual Mode
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {channelsConfig.mode === 'manual' && Object.values(channelsConfig.columnMappings).some(col => col) && (
                        <div className="bg-amber-50 border-2 border-amber-300 rounded-lg p-4">
                          <div className="flex items-center justify-between">
                            <div>
                              <h3 className="text-lg font-bold text-amber-900">‚ö†Ô∏è Using Manual Mode</h3>
                              <p className="text-sm text-amber-800 mt-1">
                                Channel columns were detected but you're using manual mode. Switch to column mapping to use per-article channels.
                              </p>
                            </div>
                            <button
                              onClick={() => setChannelsConfig(prev => ({ ...prev, mode: 'columns' }))}
                              className="px-4 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold text-sm"
                            >
                              Switch to Column Mapping
                            </button>
                          </div>
                        </div>
                      )}

                      <div className="bg-white border-2 border-gray-300 rounded-lg p-6">
                        {channelsConfig.mode === 'columns' ? (
                          <>
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Map Channel Columns</h3>
                            <p className="text-sm text-gray-600 mb-4">
                              Map your CSV columns to channel visibility settings. The tool will automatically read true/false values from these columns for each article.
                            </p>
                            
                            <div className="space-y-4">
                              {[
                                { key: 'application', label: 'application (Internal App)', desc: 'IsVisibleInApp column' },
                                { key: 'sites', label: 'sites (Public Knowledge Base)', desc: 'IsVisibleInPkb column' },
                                { key: 'csp', label: 'csp (Customer)', desc: 'IsVisibleInCsp column' },
                                { key: 'prm', label: 'prm (Partner)', desc: 'IsVisibleInPrm column' }
                              ].map(channel => (
                                <div key={channel.key} className="border border-gray-200 rounded-lg p-4">
                                  <label className="block text-sm font-semibold text-gray-800 mb-2">
                                    {channel.label}
                                  </label>
                                  <select
                                    value={channelsConfig.columnMappings[channel.key]}
                                    onChange={(e) => setChannelsConfig(prev => ({
                                      ...prev,
                                      columnMappings: {
                                        ...prev.columnMappings,
                                        [channel.key]: e.target.value
                                      }
                                    }))}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  >
                                    <option value="">-- Not mapped --</option>
                                    {csvHeaders.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                  <p className="text-xs text-gray-500 mt-1">{channel.desc}</p>
                                </div>
                              ))}
                            </div>
                          </>
                        ) : (
                          <>
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Select Channel(s)</h3>
                            <p className="text-sm text-gray-600 mb-4">
                              Choose where you want these articles to be available. You can select multiple channels. These will apply to ALL articles.
                            </p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all ${
                            channelsConfig.application ? 'border-sf-blue-500 bg-sf-blue-50' : 'border-gray-200 hover:border-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={channelsConfig.application}
                              onChange={(e) => setChannelsConfig(prev => ({ ...prev, application: e.target.checked }))}
                              className="mt-1 h-5 w-5 text-sf-blue-600 rounded"
                            />
                            <div className="ml-3">
                              <div className="font-semibold text-gray-900">application</div>
                              <div className="text-sm text-gray-600 mt-1">Internal App</div>
                              <div className="text-xs text-gray-500 mt-1">
                                Articles available in Salesforce internal knowledge base
                              </div>
                            </div>
                          </label>

                          <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all ${
                            channelsConfig.sites ? 'border-sf-blue-500 bg-sf-blue-50' : 'border-gray-200 hover:border-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={channelsConfig.sites}
                              onChange={(e) => setChannelsConfig(prev => ({ ...prev, sites: e.target.checked }))}
                              className="mt-1 h-5 w-5 text-sf-blue-600 rounded"
                            />
                            <div className="ml-3">
                              <div className="font-semibold text-gray-900">sites</div>
                              <div className="text-sm text-gray-600 mt-1">Public Knowledge Base</div>
                              <div className="text-xs text-gray-500 mt-1">
                                Articles available on public community sites
                              </div>
                            </div>
                          </label>

                          <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all ${
                            channelsConfig.csp ? 'border-sf-blue-500 bg-sf-blue-50' : 'border-gray-200 hover:border-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={channelsConfig.csp}
                              onChange={(e) => setChannelsConfig(prev => ({ ...prev, csp: e.target.checked }))}
                              className="mt-1 h-5 w-5 text-sf-blue-600 rounded"
                            />
                            <div className="ml-3">
                              <div className="font-semibold text-gray-900">csp</div>
                              <div className="text-sm text-gray-600 mt-1">Customer</div>
                              <div className="text-xs text-gray-500 mt-1">
                                Articles available for customer community users
                              </div>
                            </div>
                          </label>

                          <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all ${
                            channelsConfig.prm ? 'border-sf-blue-500 bg-sf-blue-50' : 'border-gray-200 hover:border-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={channelsConfig.prm}
                              onChange={(e) => setChannelsConfig(prev => ({ ...prev, prm: e.target.checked }))}
                              className="mt-1 h-5 w-5 text-sf-blue-600 rounded"
                            />
                            <div className="ml-3">
                              <div className="font-semibold text-gray-900">prm</div>
                              <div className="text-sm text-gray-600 mt-1">Partner</div>
                              <div className="text-xs text-gray-500 mt-1">
                                Articles available for partner community users
                              </div>
                            </div>
                          </label>
                        </div>
                            
                            <div className="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                              <h4 className="text-sm font-semibold text-gray-800 mb-2">Preview: Channels Value</h4>
                              <code className="block bg-gray-800 text-green-400 p-3 rounded text-sm font-mono">
                                {(() => {
                                  const selected = [];
                                  if (channelsConfig.application) selected.push('application');
                                  if (channelsConfig.sites) selected.push('sites');
                                  if (channelsConfig.csp) selected.push('csp');
                                  if (channelsConfig.prm) selected.push('prm');
                                  return selected.length > 0 ? selected.join('+') : 'application (default)';
                                })()}
                              </code>
                              <p className="text-xs text-gray-600 mt-2">
                                {(() => {
                                  const selected = [];
                                  if (channelsConfig.application) selected.push('application');
                                  if (channelsConfig.sites) selected.push('sites');
                                  if (channelsConfig.csp) selected.push('csp');
                                  if (channelsConfig.prm) selected.push('prm');
                                  return selected.length > 0 
                                    ? `This value will be added to the "Channels" column in your CSV for all articles.`
                                    : 'No channels selected. Default "application" will be used.';
                                })()}
                              </p>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  )}

                  {step === 8 && (
                    <div className="space-y-6">
                      <h2 className="text-2xl font-bold text-gray-800">Generate Import Package</h2>
                      
                      {Object.keys(uploadedImages).length > 0 && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                          <h3 className="font-semibold text-green-900 mb-2">‚úì Image Path Transformation Preview</h3>
                          <div className="text-xs space-y-2">
                            <p className="text-green-800">
                              <strong>Original (Salesforce URL in CSV):</strong>
                            </p>
                            <code className="block bg-white p-2 rounded text-red-700 overflow-x-auto break-all">
                              {`<img src="https://...sandbox.file.force.com/servlet/rtaImage?eid=ka0cp000000Bwv7&amp;feoid=00NBZ0000010tg1&amp;refid=0EMcp000002rBfJ" />`}
                            </code>
                            <p className="text-green-800 mt-2">
                              <strong>Transformed (In Generated HTML File):</strong>
                            </p>
                            <code className="block bg-white p-2 rounded text-green-700 overflow-x-auto">
                              {`<img src="images/${Object.keys(uploadedImages)[0]}.${uploadedImages[Object.keys(uploadedImages)[0]].extension}" />`}
                            </code>
                            <p className="text-green-700 font-medium mt-2">
                              ‚úì Handles both &amp; and &amp;amp; in URLs
                            </p>
                            <p className="text-green-700 italic">
                              ‚úì All Salesforce URLs automatically converted to relative paths
                            </p>
                            <p className="text-green-700 italic">
                              ‚úì Uses correct image format (.png, .jpg, .gif) per uploaded file
                            </p>
                          </div>
                        </div>
                      )}
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">üì¶ ZIP File Structure</h3>
                        
                        {!translationConfig.hasTranslations ? (
                          <>
                            <pre className="text-xs font-mono text-blue-800 bg-white p-3 rounded border border-blue-200 overflow-x-auto">
{`salesforce-knowledge-import.zip
‚îú‚îÄ‚îÄ properties.properties
‚îú‚îÄ‚îÄ PreppedData.csv
‚îú‚îÄ‚îÄ Answer_data/                (Article_Answer__c files & images)
‚îÇ   ‚îú‚îÄ‚îÄ File2.html
‚îÇ   ‚îú‚îÄ‚îÄ File3.html
‚îÇ   ‚îî‚îÄ‚îÄ images/
‚îÇ       ‚îú‚îÄ‚îÄ 0EMcp000002rB5p.png
‚îÇ       ‚îú‚îÄ‚îÄ 0EMcp000002rB5q.jpg
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ExternalContent_data/       (External_Content__c files & images)
    ‚îú‚îÄ‚îÄ File2.html
    ‚îú‚îÄ‚îÄ File3.html
    ‚îî‚îÄ‚îÄ images/
        ‚îú‚îÄ‚îÄ 0EMcp000002rB5r.gif
        ‚îî‚îÄ‚îÄ ...`}
                            </pre>
                            <p className="text-xs text-blue-700 mt-2">
                              <strong>‚úì Salesforce Requirements Met:</strong>
                            </p>
                            <ul className="text-xs text-blue-700 list-disc list-inside mt-1 ml-2">
                              <li>Each rich text field has its own folder at top level (columnName_data)</li>
                              <li>Each folder contains HTML files and its own images subfolder</li>
                              <li>Relative image paths from HTML: <code className="bg-white px-1 rounded">images/refid.ext</code></li>
                              <li>Supported formats: .png, .gif, .jpg (auto-detected)</li>
                              <li>Each file ‚â§ 1 MB (per Salesforce limits)</li>
                            </ul>
                          </>
                        ) : (
                          <>
                            <div className="bg-purple-50 border border-purple-300 rounded p-2 mb-2">
                              <p className="text-xs text-purple-800 font-semibold">
                                üåç Translations Detected - Using Translation-Specific Folder Structure
                              </p>
                            </div>
                            <pre className="text-xs font-mono text-blue-800 bg-white p-3 rounded border border-blue-200 overflow-x-auto">
{`salesforce-knowledge-import.zip
‚îú‚îÄ‚îÄ properties.properties
‚îú‚îÄ‚îÄ PreppedData.csv              (Master rows first, then translations)
‚îú‚îÄ‚îÄ Answer_data/                 (Article_Answer__c files & images)
‚îÇ   ‚îú‚îÄ‚îÄ File1.html               (ArticleNumber 1 - Master Language)
‚îÇ   ‚îú‚îÄ‚îÄ File1/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fr.html              (ArticleNumber 1 - French Translation)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ es.html              (ArticleNumber 1 - Spanish Translation)
‚îÇ   ‚îú‚îÄ‚îÄ File2.html               (ArticleNumber 2 - Master Language)
‚îÇ   ‚îú‚îÄ‚îÄ File2/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ de.html              (ArticleNumber 2 - German Translation)
‚îÇ   ‚îî‚îÄ‚îÄ images/
‚îÇ       ‚îú‚îÄ‚îÄ 0EMcp000002rB5p.png
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ExternalContent_data/        (External_Content__c files & images)
    ‚îú‚îÄ‚îÄ File1.html               (ArticleNumber 1 - Master Language)
    ‚îú‚îÄ‚îÄ File1/
    ‚îÇ   ‚îú‚îÄ‚îÄ fr.html              (French Translation)
    ‚îÇ   ‚îî‚îÄ‚îÄ es.html              (Spanish Translation)
    ‚îî‚îÄ‚îÄ images/
        ‚îî‚îÄ‚îÄ ...`}
                            </pre>
                            <p className="text-xs text-blue-700 mt-2">
                              <strong>‚úì Salesforce Translation Requirements Met:</strong>
                            </p>
                            <ul className="text-xs text-blue-700 list-disc list-inside mt-1 ml-2">
                              <li><strong>Master language files:</strong> <code className="bg-white px-1 rounded">columnName_data/File{`{ArticleNumber}`}.html</code></li>
                              <li><strong>Translation files:</strong> <code className="bg-white px-1 rounded">columnName_data/File{`{ArticleNumber}`}/{`{language}`}.html</code></li>
                              <li><strong>CSV row order:</strong> Master row first, followed by translations for each article</li>
                              <li><strong>isMasterLanguage:</strong> Converted from true/false to 1/0</li>
                              <li>Each rich text field has its own folder at top level (columnName_data)</li>
                              <li>Relative image paths from HTML: <code className="bg-white px-1 rounded">images/refid.ext</code></li>
                            </ul>
                          </>
                        )}
                      </div>
                      
                      <div className="grid grid-cols-2 gap-6">
                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="font-semibold text-gray-800 mb-3">Summary</h3>
                          <dl className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <dt className="text-gray-600">Total Rows:</dt>
                              <dd className="font-medium">{csvData?.length || 0}</dd>
                            </div>
                            <div className="flex justify-between">
                              <dt className="text-gray-600">Rich Text Columns:</dt>
                              <dd className="font-medium">{richTextColumns.length}</dd>
                            </div>
                            <div className="flex justify-between">
                              <dt className="text-gray-600">Images:</dt>
                              <dd className="font-medium">{Object.keys(uploadedImages).length}</dd>
                            </div>
                            <div className="flex justify-between">
                              <dt className="text-gray-600">RecordType:</dt>
                              <dd className="font-medium">{recordTypeData.enabled ? '‚úì Enabled' : '‚úó Not configured'}</dd>
                            </div>
                            <div className="flex justify-between">
                              <dt className="text-gray-600">Lookup Fields:</dt>
                              <dd className="font-medium">{lookupFields.filter(l => l.parsedData).length}/{lookupFields.length}</dd>
                            </div>
                            <div className="flex justify-between">
                              <dt className="text-gray-600">Data Categories:</dt>
                              <dd className="font-medium">{dataCategoryGroups.length}</dd>
                            </div>
                          </dl>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="font-semibold text-gray-800 mb-3">Output Settings</h3>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">CSV Encoding</label>
                              <select value={outputSettings.csvEncoding} onChange={(e) => setOutputSettings(p => ({ ...p, csvEncoding: e.target.value }))}
                                      className="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                <option>UTF-8</option>
                                <option>ISO-8859-1</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Date Format</label>
                              <input type="text" value={outputSettings.dateFormat} onChange={(e) => setOutputSettings(p => ({ ...p, dateFormat: e.target.value }))}
                                     className="w-full px-2 py-1 text-sm border border-gray-300 rounded" 
                                     placeholder="yyyy-MM-dd" />
                              <p className="text-xs text-gray-500 mt-0.5">Default: yyyy-MM-dd</p>
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">DateTime Format</label>
                              <input type="text" value={outputSettings.dateTimeFormat} onChange={(e) => setOutputSettings(p => ({ ...p, dateTimeFormat: e.target.value }))}
                                     className="w-full px-2 py-1 text-sm border border-gray-300 rounded" 
                                     placeholder="yyyy-MM-dd HH:mm:ss" />
                              <p className="text-xs text-gray-500 mt-0.5">Default: yyyy-MM-dd HH:mm:ss</p>
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Output Filename</label>
                              <input type="text" value={outputSettings.outputFilename} onChange={(e) => setOutputSettings(p => ({ ...p, outputFilename: e.target.value }))}
                                     className="w-full px-2 py-1 text-sm border border-gray-300 rounded" />
                            </div>
                          </div>
                        </div>
                      </div>
                      <button onClick={generateZipFile} className="w-full flex items-center justify-center gap-2 px-6 py-4 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all font-semibold text-lg">
                        <Download size={24} /> Generate & Download ZIP
                      </button>
                    </div>
                  )}

                  <div className="flex justify-between mt-8 pt-6 border-t border-gray-200">
                    <button onClick={() => {
                      let prevStep = step - 1;
                      // Skip step 4 (Images) if no rich text columns when going back from step 5
                      if (step === 5 && richTextColumns.length === 0) {
                        prevStep = 3;
                      }
                      setStep(Math.max(0, prevStep));
                    }} disabled={step === 0}
                            className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                      <ChevronLeft size={20} /> Previous
                    </button>
                    {step < 8 && (
                      <button onClick={() => {
                        const validationResult = validateStepTransition(step);
                        if (!validationResult.canProceed) {
                          // Set warning acknowledged for next click if it's a warning
                          if (validationResult.hasWarning) {
                            // For step 4 images, need to check which warning type
                            if (step === 4 && imageReferences.length > 0) {
                              const uploadedCount = Object.keys(uploadedImages).length;
                              if (uploadedCount === 0) {
                                setWarningAcknowledged(prev => ({ ...prev, [`step${step}_none`]: true }));
                              } else if (uploadedCount < imageReferences.length) {
                                setWarningAcknowledged(prev => ({ ...prev, [`step${step}_partial`]: true }));
                              }
                            } else {
                              setWarningAcknowledged(prev => ({ ...prev, [`step${step}`]: true }));
                            }
                          }
                          return;
                        }
                        
                        // Clear warning acknowledgment after proceeding
                        setWarningAcknowledged(prev => {
                          const newState = { ...prev };
                          delete newState[`step${step}`];
                          delete newState[`step${step}_none`];
                          delete newState[`step${step}_partial`];
                          return newState;
                        });
                        
                        let nextStep = step + 1;
                        // Skip step 4 (Images) if no rich text columns
                        if (step === 3 && richTextColumns.length === 0) {
                          nextStep = 5;
                        }
                        setStep(Math.min(8, nextStep));
                      }} disabled={step > 0 && !csvData}
                              className="flex items-center gap-2 px-6 py-2 bg-sf-blue-500 text-white rounded-lg hover:bg-sf-blue-600 shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        Next <ChevronRight size={20} />
                      </button>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Toast Notification */}
              {toast.show && (
                <div className="fixed top-4 right-4 z-50 animate-slide-in max-w-md">
                  <div className={`rounded-lg shadow-lg p-4 flex items-start gap-3 ${
                    toast.type === 'success' ? 'bg-green-500 text-white' :
                    toast.type === 'error' ? 'bg-red-500 text-white' :
                    toast.type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                  }`}>
                    {toast.type === 'success' && (
                      <svg className="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                      </svg>
                    )}
                    {toast.type === 'error' && (
                      <svg className="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    )}
                    {toast.type === 'warning' && (
                      <svg className="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                    )}
                    {toast.type === 'info' && (
                      <svg className="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    )}
                    <span className="font-medium flex-1">{toast.message}</span>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Wait for all libraries to load
        if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined' && typeof Papa !== 'undefined') {
          const root = ReactDOM.createRoot(document.getElementById('root'));
          root.render(React.createElement(SalesforceKnowledgeImportTool));
        } else {
          console.error('Libraries not loaded properly');
          document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">Error: Required libraries failed to load. Please check your internet connection and refresh the page.</div>';
        }
    </script>
</body>
</html>
